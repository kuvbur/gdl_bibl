!------------------------
! Reinforcement
! 2012, Eptar Kft.
!------------------------
eps=0.0001
newedgelength=0.2
benablehsedit=1
bdetailedarc=1
bdefaultelem=(glob_intguid="" |glob_intguid="{00000000-0000-0000-0000-000000000000}" )

dim stedittypes[3]
stedittypes[1]=`Расстояние и количество`
stedittypes[2]=`Шаг и количество`
stedittypes[3]=`Шаг и расстояние`

dim view_part_m[3]
view_part_m[1] = "Только низ"
view_part_m[2] = "Только верх"
view_part_m[3] = "Вид сверху"
values "view_part" view_part_m

editby_dist_n=1
editby_l_n=2
editby_dist_l=3

dim stdetlevel[3]
stdetlevel[1]=`Стержень`
stdetlevel[2]=`Линия`
stdetlevel[3]=`Откл`

dim stposition[2]
stposition[1]=`Горизонтально`
stposition[2]=`Вертикально`

pos_hor=1
pos_ver=2
pos_lat=3
view_top=1
view_side=2
view_section=3

dim ststirrupsubtype[12]
ststirrupsubtype[1]=`Хомут 1`
ststirrupsubtype[2]=`Хомут 2`
ststirrupsubtype[3]=`Шпилька 1`
ststirrupsubtype[4]=`Шпилька 2`
ststirrupsubtype[5]=`Выпуск колонны`
ststirrupsubtype[6]=`Type 6.`
ststirrupsubtype[7]=`Type 7.`
ststirrupsubtype[8]=`П-образный`
ststirrupsubtype[9]=`Type 9.`
ststirrupsubtype[10]=`Г-образный`
ststirrupsubtype[11]=`Type Circle`
ststirrupsubtype[12]=`Type Polygon`
type_stirrup_normal=1
type_stirrup_type_2=2
type_stirrup_type_3=3
type_stirrup_type_4=4
type_stirrup_type_5=5
type_stirrup_type_6=6
type_stirrup_type_7=7
type_stirrup_type_8=8
type_stirrup_type_9=9
type_stirrup_type_10=10
type_stirrup_circle=90
type_stirrup_polygon=99
iron_type_rebar=1
iron_type_stirrup=2
iron_type_mesh=3
version=20120711
file_dependence "rf_stirrup","rf_mesh","rf_rebar","rf_column","rf_beam","rf_ring","rf_label","rf_list","rf_concrete"
minpolyx=0
minpolyy=0
maxpolyx=0
maxpolyy=0
centerx=0
centery=0
values "stirrupSubType" ststirrupsubtype
values "iStirrupSubType" 1,2,3,4,5,6,7,8,9,10,13,type_stirrup_circle,type_stirrup_polygon
if glob_modpar_name="stirrupSubType" then
	istirrupsubtype=1
	for i=2 to vardim1(ststirrupsubtype)
		if stirrupsubtype=ststirrupsubtype[i] then
			if i<vardim1(ststirrupsubtype)-1 then
				istirrupsubtype=i
			else
				if i=vardim1(ststirrupsubtype) then
					istirrupsubtype=type_stirrup_polygon
				else
					istirrupsubtype=type_stirrup_circle
				endif
			endif
			i=vardim1(ststirrupsubtype)
		endif
	next i
	parameters istirrupsubtype=istirrupsubtype
else
	if istirrupsubtype<vardim1(ststirrupsubtype)-1 then
		istirrupsubtype=max(min(istirrupsubtype,vardim1(ststirrupsubtype)-2),1)
		parameters stirrupsubtype=ststirrupsubtype[istirrupsubtype]
	else
		if istirrupsubtype=type_stirrup_circle then
			parameters stirrupsubtype=ststirrupsubtype[vardim1(ststirrupsubtype)-1]
		else
			istirrupsubtype=type_stirrup_polygon
			parameters stirrupsubtype=ststirrupsubtype[vardim1(ststirrupsubtype)]
		endif
	endif
endif
if iprevsubtype<>istirrupsubtype then
	if istirrupsubtype=type_stirrup_polygon then
		dim _stirruppointcoords[][3]
		dim _stirruparcpoints[]
		if bdefaultelem then
			itype=type_stirrup_polygon
		else
			itype=iprevsubtype
		endif
		gosub "typeDefinition"
		dim stirruppointcoords[][3]
		dim stirrupprevcoords[][3]
		dim stirruparcpoints[]
		stirruppointcoords=_stirruppointcoords
		stirrupprevcoords=_stirruppointcoords
		stirruparcpoints=_stirruparcpoints
		nstirruppoint=vardim1(stirruppointcoords)
		benableedit=1
		bshoweditview=1
		parameters stirruppointcoords=stirruppointcoords,
		stirrupprevcoords=stirrupprevcoords,
		stirruparcpoints=stirruparcpoints,
		nstirruppoint=nstirruppoint,
		bclosedpolygon=bclosedpolygon,
		bstirrupback1=bstirrupback1,
		bstirrupback2=bstirrupback2,
		stirrupang1=stirrupang1,
		stirrupang2=stirrupang2,
		benableedit=benableedit,
		bshoweditview=bshoweditview
	endif
endif
iprevsubtype=istirrupsubtype
parameters iprevsubtype=iprevsubtype
benableback1=0
benableback2=0
benableang1=0
benableang2=0
benableclose=0
benablex=0
benabley=0
benablecircle=0
benabledist=1
benablepolyedit=0
benablepolynum=0
bdefinedtype=(istirrupsubtype=type_stirrup_type_2)|\
(istirrupsubtype=type_stirrup_type_3)|\
(istirrupsubtype=type_stirrup_type_4)|\
(istirrupsubtype=type_stirrup_type_5)|\
(istirrupsubtype=type_stirrup_type_6)|\
(istirrupsubtype=type_stirrup_type_7)|\
(istirrupsubtype=type_stirrup_type_8)|\
(istirrupsubtype=type_stirrup_type_9)|\
(istirrupsubtype=type_stirrup_type_10)|\
(istirrupsubtype=type_stirrup_circle)
if istirrupsubtype=type_stirrup_normal then
	bclosedpolygon=1
	bstirrupback1=1
	bstirrupback2=1
	benableback1=0
	benableback2=0
	benableang1=0
	benableang2=0
	benableclose=0
	benablex=1
	benabley=1
	benabledist=1
endif
if istirrupsubtype=type_stirrup_polygon then
	benableback1=1
	benableback2=1
	benableang1=1
	benableang2=1
	benableclose=1
	benablepolyedit=1
	benablepolynum=1
endif
if bdefinedtype then
	benablehsedit=0
	dim _stirruppointcoords[][3]
	dim _stirruparcpoints[]
	itype=istirrupsubtype
	gosub "typeDefinition"
	dim stirruppointcoords[][3]
	dim stirruparcpoints[]
	stirruppointcoords=_stirruppointcoords
	stirruparcpoints=_stirruparcpoints
endif
if bclosedpolygon then
	bstirrupback1=1
	bstirrupback2=1
	benableback1=0
	benableback2=0
endif
if iposition=pos_hor then
	stirrupoffsetx=0
	stirrupoffsety=0
endif
if istirrupsubtype=type_stirrup_polygon|bdefinedtype then
	_nstirruppoint=min(nstirruppoint,vardim1(stirruppointcoords) )
	dim _newironpointhot[][2]
	dim _sidelength[]
	dim _arcangle[]
	dim _polygondir[]
	dim _arccenter[][2]
	dim _radiusdistance[]
	gosub "NewPointsCalculation"
	benablehsedit=benableedit*benablepolyedit
endif
homedbintid=0
homedbuserid=0
homedbname=""
homecontext=0
bhomesection=0
bsectionelevationcontext=0
qq=request( "HomeDB_info","",homedbintid,homedbuserid,homedbname,homecontext)
if qq then bsectionelevationcontext=(homecontext=2)
if homecontext=2&homedb<>2 then
	bhomesection=1
	homeangle=symb_rotangle
	parameters homeangle=homeangle
endif
parameters bhomesection=bhomesection
imirrored=1-2*symb_mirrored
if n>1 then
	strtext1=str(n,1,0)+"x"+"O"+str{2}( "%.0mm",d)+"/"+str{2}( "%.0cm",disthoops)
else
	strtext1=str(n,1,0)+"x"+"O"+str{2}( "%.0mm",d)
endif
strtext2="l="+str{2}( "%.2m",ironlistingdata[1][2])+"m"
parameters strtext1=strtext1,strtext2=strtext2
goto "endMasterSript"
"calculateDirection":
	pdirection=1
	area=0
	dim polygon1[][2]
	tempnumpnts=_nstirruppoint+1
	polygon1[_nstirruppoint+1][1]=stirruppointcoords[1][1]
	polygon1[_nstirruppoint+1][2]=stirruppointcoords[1][2]
	for i=_nstirruppoint to 1 step-1
		polygon1[i][1]=stirruppointcoords[i][1]
		polygon1[i][2]=stirruppointcoords[i][2]
	next i
	for areai=1 to tempnumpnts-1
		area=area+(polygon1[areai+1][1]+polygon1[areai][1])*(polygon1[areai+1][2]-polygon1[areai][2])*0.5
	next areai
	area=area+(polygon1[1][1]+polygon1[tempnumpnts][1])*(polygon1[1][2]-polygon1[tempnumpnts][2])*0.5
	if area<0 then pdirection=-1
return
"NewPointsCalculation":
	for i=_nstirruppoint to 1 step-1
		if i=_nstirruppoint then
			tempsidex=stirruppointcoords[1][1]-stirruppointcoords[i][1]
			tempsidey=stirruppointcoords[1][2]-stirruppointcoords[i][2]
		else
			tempsidex=stirruppointcoords[i+1][1]-stirruppointcoords[i][1]
			tempsidey=stirruppointcoords[i+1][2]-stirruppointcoords[i][2]
		endif
		_sidelength[i]=sqr(tempsidex^2+tempsidey^2)
		newpointdist=((2/3)-0.5)*_sidelength[i]
		if abs(_sidelength[i])>eps then
			_arcangle[i]=atn(stirruparcpoints[i]/(_sidelength[i]/2) )*4
		else
			_arcangle[i]=0
		endif
		_polygondir[i]=1
		if tempsidex<-eps then _polygondir[i]=-1
		if abs(tempsidex)>eps then
			arcalpha1=atn(tempsidey/tempsidex)-90*_polygondir[i]
			arcalpha2=atn(tempsidey/tempsidex)+90*_polygondir[i]
		else
			if i=_nstirruppoint then
				tempendy=stirruppointcoords[1][2]
			else
				tempendy=stirruppointcoords[i+1][2]
			endif
			if stirruppointcoords[i][2]-tempendy>eps then
				arcalpha1=180
				arcalpha2=0
			else
				arcalpha1=0
				arcalpha2=180
			endif
		endif
		if abs(stirruparcpoints[i])>eps&abs(sin(_arcangle[i]/4) )>eps then
			_radiusdistance[i]=sqr((_sidelength[i]/2) ^2+stirruparcpoints[i] ^2)/2/sin(_arcangle[i]/4)-stirruparcpoints[i]
			_sidelength[i]=abs(((2*abs(stirruparcpoints[i]+_radiusdistance[i])*pi)/360)*_arcangle[i])
		else
			_radiusdistance[i]=0
		endif
		_arccenter[i][1]=stirruppointcoords[i][1]+(tempsidex)/2+cos(arcalpha2)*_radiusdistance[i]
		_arccenter[i][2]=stirruppointcoords[i][2]+(tempsidey)/2+sin(arcalpha2)*_radiusdistance[i]
		_newironpointhot[i][1]=stirruppointcoords[i][1]+(tempsidex)/2+cos(arcalpha1)*stirruparcpoints[i]+cos(arcalpha1+90)*newpointdist
		_newironpointhot[i][2]=stirruppointcoords[i][2]+(tempsidey)/2+sin(arcalpha1)*stirruparcpoints[i]+sin(arcalpha1+90)*newpointdist
	next i
return

"typeDefinition":
	if itype=type_stirrup_normal then
		bclosedpolygon=1
		bstirrupback1=1
		bstirrupback2=1
		benablex=1
		benabley=1
		_stirruppointcoords[4][1]=0
		_stirruppointcoords[4][2]=hoopy
		_stirruppointcoords[4][3]=0
		_stirruppointcoords[3][1]=0
		_stirruppointcoords[3][2]=0
		_stirruppointcoords[3][3]=0
		_stirruppointcoords[2][1]=hoopx
		_stirruppointcoords[2][2]=0
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=hoopx
		_stirruppointcoords[1][2]=hoopy
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[4]=0
		_stirruparcpoints[3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_type_2 then
		bclosedpolygon=0
		bstirrupback1=1
		bstirrupback2=1
		benableang1=1
		benableang2=1
		benablex=1
		benabley=1
		_stirruppointcoords[4][1]=hoopx
		_stirruppointcoords[4][2]=hoopy
		_stirruppointcoords[4][3]=0
		_stirruppointcoords[3][1]=hoopx
		_stirruppointcoords[3][2]=0
		_stirruppointcoords[3][3]=0
		_stirruppointcoords[2][1]=0
		_stirruppointcoords[2][2]=0
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=0
		_stirruppointcoords[1][2]=hoopy
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[4]=0
		_stirruparcpoints[3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_type_3 then
		bclosedpolygon=0
		bstirrupback1=1
		bstirrupback2=1
		benableang1=1
		benableang2=1
		benabley=1
		benabledist=0
		_stirruppointcoords[2][1]=0
		_stirruppointcoords[2][2]=hoopy
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=0
		_stirruppointcoords[1][2]=0
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_type_4 then
		bclosedpolygon=0
		bstirrupback1=1
		bstirrupback2=1
		stirrupang2=-stirrupang2
		benableang1=1
		benableang2=1
		benabley=1
		benabledist=0
		_stirruppointcoords[2][1]=-bendradius
		_stirruppointcoords[2][2]=hoopy
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=bendradius
		_stirruppointcoords[1][2]=0
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	if itype=type_stirrup_type_5 then
		bclosedpolygon=0
		bstirrupback1=0
		bstirrupback2=0
		benablex=1
		benabley=1
		_stirruppointcoords[4][1]=otstup
		_stirruppointcoords[4][2]=h_et+t_perekr+h_vipusk
		_stirruppointcoords[4][3]=0

		_stirruppointcoords[3][1]=otstup
		_stirruppointcoords[3][2]=h_et+t_perekr
		_stirruppointcoords[3][3]=0

		_stirruppointcoords[2][1]=0
		_stirruppointcoords[2][2]=h_et
		_stirruppointcoords[2][3]=0

		_stirruppointcoords[1][1]=0
		_stirruppointcoords[1][2]=0
		_stirruppointcoords[1][3]=0

		_stirruparcpoints[4]=0
		_stirruparcpoints[3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_type_6 then
		bclosedpolygon=0
		bstirrupback1=1
		bstirrupback2=1
		stirrupang1=45
		stirrupang2=45
		benablex=1
		benabley=1
		_stirruppointcoords[6][1]=d
		_stirruppointcoords[6][2]=hoopy-d
		_stirruppointcoords[6][3]=d
		_stirruppointcoords[5][1]=hoopx
		_stirruppointcoords[5][2]=hoopy-d
		_stirruppointcoords[5][3]=d
		_stirruppointcoords[4][1]=hoopx
		_stirruppointcoords[4][2]=0
		_stirruppointcoords[4][3]=0
		_stirruppointcoords[3][1]=0
		_stirruppointcoords[3][2]=0
		_stirruppointcoords[3][3]=0
		_stirruppointcoords[2][1]=0
		_stirruppointcoords[2][2]=hoopy
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=hoopx
		_stirruppointcoords[1][2]=hoopy
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[6]=0
		_stirruparcpoints[5]=0
		_stirruparcpoints[4]=0
		_stirruparcpoints[3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_type_7 then
		bclosedpolygon=0
		bstirrupback1=1
		bstirrupback2=1
		stirrupang1=90
		stirrupang2=90
		benablex=1
		benabley=1
		_stirruppointcoords[6][1]=4*d
		_stirruppointcoords[6][2]=hoopy-d
		_stirruppointcoords[6][3]=d
		_stirruppointcoords[5][1]=hoopx
		_stirruppointcoords[5][2]=hoopy-d
		_stirruppointcoords[5][3]=d
		_stirruppointcoords[4][1]=hoopx
		_stirruppointcoords[4][2]=0
		_stirruppointcoords[4][3]=0
		_stirruppointcoords[3][1]=0
		_stirruppointcoords[3][2]=0
		_stirruppointcoords[3][3]=0
		_stirruppointcoords[2][1]=0
		_stirruppointcoords[2][2]=hoopy
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=hoopx-4*d
		_stirruppointcoords[1][2]=hoopy
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[6]=0
		_stirruparcpoints[5]=0
		_stirruparcpoints[4]=0
		_stirruparcpoints[3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_type_8 then
		bclosedpolygon=0
		bstirrupback1=0
		bstirrupback2=0
		benablex=1
		benabley=1
		_stirruppointcoords[4][1]=-hoopx
		_stirruppointcoords[4][2]=hoopy
		_stirruppointcoords[4][3]=0
		_stirruppointcoords[3][1]=0
		_stirruppointcoords[3][2]=hoopy
		_stirruppointcoords[3][3]=0
		_stirruppointcoords[2][1]=0
		_stirruppointcoords[2][2]=0
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=-hoopx
		_stirruppointcoords[1][2]=0
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[4]=0
		_stirruparcpoints[3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_type_9 then
		bclosedpolygon=0
		bstirrupback1=1
		bstirrupback2=1
		benableang1=1
		benableang2=1
		benablex=1
		benabley=1
		_stirruppointcoords[4][1]=-hoopx
		_stirruppointcoords[4][2]=hoopy
		_stirruppointcoords[4][3]=0
		_stirruppointcoords[3][1]=0
		_stirruppointcoords[3][2]=hoopy
		_stirruppointcoords[3][3]=0
		_stirruppointcoords[2][1]=0
		_stirruppointcoords[2][2]=0
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=-hoopx
		_stirruppointcoords[1][2]=0
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[4]=0
		_stirruparcpoints[3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_type_10 then
		bclosedpolygon=0
		bstirrupback1=0
		bstirrupback2=0
		benableang1=0
		benableang2=0
		benablex=1
		benabley=1
		_stirruppointcoords[3][1]=-hoopx
		_stirruppointcoords[3][2]=0
		_stirruppointcoords[3][3]=0
		_stirruppointcoords[2][1]=0
		_stirruppointcoords[2][2]=0
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=0
		_stirruppointcoords[1][2]=-hoopy
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_circle then
		bclosedpolygon=0
		bstirrupback1=1
		bstirrupback2=1
		stirrupang1=90
		stirrupang2=90
		benablecircle=1
		_stirruppointcoords[5][1]=hoopcircle/2
		_stirruppointcoords[5][2]=max(2*d,bendradius)+0.001
		_stirruppointcoords[5][3]=d
		_stirruppointcoords[4][1]=hoopcircle/2
		_stirruppointcoords[4][2]=0
		_stirruppointcoords[4][3]=d
		_stirruppointcoords[3][1]=-hoopcircle/2
		_stirruppointcoords[3][2]=0
		_stirruppointcoords[3][3]=0
		_stirruppointcoords[2][1]=hoopcircle/2
		_stirruppointcoords[2][2]=0
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=hoopcircle/2
		_stirruppointcoords[1][2]=-max(2*d,bendradius)-0.001
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[5]=0
		_stirruparcpoints[4]=0
		_stirruparcpoints[3]=hoopcircle/2
		_stirruparcpoints[2]=hoopcircle/2
		_stirruparcpoints[1]=0
	endif
	if itype=type_stirrup_polygon then
		bclosedpolygon=1
		bstirrupback1=1
		bstirrupback2=1
		_stirruppointcoords[6][1]=hoopx*0.25
		_stirruppointcoords[6][2]=hoopy
		_stirruppointcoords[6][3]=0
		_stirruppointcoords[5][1]=0
		_stirruppointcoords[5][2]=hoopy*0.5
		_stirruppointcoords[5][3]=0
		_stirruppointcoords[4][1]=0
		_stirruppointcoords[4][2]=0
		_stirruppointcoords[4][3]=0
		_stirruppointcoords[3][1]=hoopx
		_stirruppointcoords[3][2]=0
		_stirruppointcoords[3][3]=0
		_stirruppointcoords[2][1]=hoopx
		_stirruppointcoords[2][2]=hoopy*0.5
		_stirruppointcoords[2][3]=0
		_stirruppointcoords[1][1]=hoopx*0.75
		_stirruppointcoords[1][2]=hoopy
		_stirruppointcoords[1][3]=0
		_stirruparcpoints[6]=0
		_stirruparcpoints[5]=0
		_stirruparcpoints[4]=0
		_stirruparcpoints[3]=0
		_stirruparcpoints[2]=0
		_stirruparcpoints[1]=0
	endif
	nstirruppoint=vardim1(_stirruppointcoords)
return
"endMasterSript":
