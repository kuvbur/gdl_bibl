dim ttype_form[]dim itype_form[] : i=0i=i+1 : itype_form[i]=0 : ttype_form[i] = "Только рамка"i=i+1 : itype_form[i]=1 : ttype_form[i] = "1"i=i+1 : itype_form[i]=2 : ttype_form[i] = "2"i=i+1 : itype_form[i]=3 : ttype_form[i] = "3"i=i+1 : itype_form[i]=4 : ttype_form[i] = "4"i=i+1 : itype_form[i]=99 : ttype_form[i] = "Разрешение на изм (А4)"i=i+1 : itype_form[i]=5 : ttype_form[i] = "Регистрация изм (титул)"i=i+1 : itype_form[i]=6 : ttype_form[i] = "Дата изм. 0"i=i+1 : itype_form[i]=7 : ttype_form[i] = "Шифр"i=i+1 : itype_form[i]=8 : ttype_form[i] = "Стадия"i=i+1 : itype_form[i]=9 : ttype_form[i] = "Название документации"i=i+1 : itype_form[i]=10 : ttype_form[i] = "Текстовый документ"i=i+1 : itype_form[i]=98 : ttype_form[i] = "Архив"i=i+1 : itype_form[i]=97 : ttype_form[i] = "Эскиз"dim size_inx[]size_inx[1] = "A0"size_inx[2] = "A1"size_inx[3] = "A2"size_inx[4] = "A3"size_inx[5] = "A4"size_inx[6] = "ПРОИЗВОЛЬНЫЙ"size_inx[7] = "A3x3"size_inx[8] = "A3x4"size_inx[9] = "A3x5"size_inx[10] = "A4x3"size_inx[11] = "A4x4"size_inx[12] = "A4x5"size_inx[13] = "A4x6"dim irtype[] : dim trtype[] : i=0i=i+1 : trtype[i] = "Обычный" : irtype[i] = 0i=i+1 : trtype[i] = "Полужирный" : irtype[i] = 1i=i+1 : trtype[i] = "Курсив" : irtype[i] = 2i=i+1 : trtype[i] = "Полужирный курсив" : irtype[i] = 3dim isorttype[] : dim tsorttype[] : i=0i=i+1 : tsorttype[i] = "Изменения->Макеты" : isorttype[i] = 0i=i+1 : tsorttype[i] = "Макеты->Изменения" : isorttype[i] = 1i=i+1 : tsorttype[i] = "Порядок из выпуска" : isorttype[i] = 2dim itype_sort_issue[] : dim ttype_sort_issue[] : i=0i=i+1 : ttype_sort_issue[i] = "Системный" : itype_sort_issue[i] = 0i=i+1 : ttype_sort_issue[i] = "По возрастанию номера изменения" : itype_sort_issue[i] = 1i=i+1 : ttype_sort_issue[i] = "По убыванию номера изменения" : itype_sort_issue[i] = 2dim size[][]i = 0i = i + 1 : size[i][1] = 84.1 : size[i][2] = 118.9 !0i = i + 1 : size[i][1] = 59.4 : size[i][2] = 84.1 !1i = i + 1 : size[i][1] = 42 : size[i][2] = 59.4 !2i = i + 1 : size[i][1] = 29.7 : size[i][2] = 42 !3i = i + 1 : size[i][1] = 21 : size[i][2] = 29.7 !4i = i + 1 : size[i][1] = aaa*0.1 : size[i][2] = bbb*0.1 !customi = i + 1 : size[i][1] = 42.0 : size[i][2] = 89.1 !7i = i + 1 : size[i][1] = 42.0 : size[i][2] = 118.9 !8i = i + 1 : size[i][1] = 42.0 : size[i][2] = 148.6 !9i = i + 1 : size[i][1] = 29.7 : size[i][2] = 63.0 !10i = i + 1 : size[i][1] = 29.7 : size[i][2] = 84.1 !11i = i + 1 : size[i][1] = 29.7 : size[i][2] = 105.1 !12i = i + 1 : size[i][1] = 29.7 : size[i][2] = 126.1 !13dim error[ ]dim position_info[ ][ ]dim agreed_info[ ][ ]dim change_info[ ][ ]dim arr1[ ]dim arr2[ ][ ]!------------------------------------------------------------------------------------------------! Check global existence!------------------------------------------------------------------------------------------------dim GlobIssueScheme[2][]dim GlobchangeScheme[2][]dim LayoutRevHistory[][]dim LayoutchangeHistory[][]_bEmptyGlobIssues = 0_bEmptyGlobchanges = 0_bEmptyLayoutRevHistory = 0_bEmptyLayoutChHistory = 0_bfirstchange = 0_bEmptychange = 0_bERROR = 0n_izm = 0n_err = 0current_phase = " "current_part = " "current_date = " "surname = " " delim = " "weight = " "subpos = " "shifrt_l = " "naen_dok = " "tend_date = " "if vardim2(GLOB_ISSUE_SCHEME) > 0 then	! global exists	GlobIssueScheme	= GLOB_ISSUE_SCHEMEelse	_bEmptyGlobIssues = 1endifif vardim2(GLOB_change_SCHEME) > 0 then	! global exists	GlobchangeScheme = GLOB_change_SCHEMEelse	_bEmptyGlobchanges = 1endifif GLOB_SCRIPT_TYPE = 2 then	_bLayoutContext = (GLOB_CONTEXT = 8 | GLOB_CONTEXT = 28)	if _bLayoutContext then		! Layout context or Layout Editing feedback: use globals from Issue Manager		LayoutRevHistory = LAYOUT_REVISION_HISTORY		LayoutchangeHistory	= LAYOUT_change_HISTORY		last_change_inx = vardim1(LayoutchangeHistory)		last_rev_inx = vardim1(LayoutRevHistory)		if vardim2(LayoutRevHistory) > 1 then			if STRSTR(LayoutRevHistory[last_rev_inx][3], "Отсутствует в Выпуске") then 				txt = "Макет добавлен в выпуск?"				gosub "write_error"			endif		else			txt = "Макет добавлен в выпуск?"			gosub "write_error"		endif	else		text2 0.05, 0.05,  "!! Работает только на макетах !!"	endifendifif vardim2(LayoutRevHistory) <> vardim2(GlobIssueScheme) then	! if global exists, must have same number of columns as GLOB_ISSUE_SCHEME	_bEmptyLayoutRevHistory = 1endifif vardim2(LayoutchangeHistory) <> vardim2(GlobchangeScheme) then	! if global exists, must have same number of columns as GLOB_change_SCHEME	_bEmptyLayoutChHistory = 1endifif not(_bEmptyLayoutRevHistory) & _bEmptyLayoutChHistory then	! if has revision data but no change attached, create 1 dummy empty change row	for _ichangeCol = 1 to vardim2(GLOB_change_SCHEME)		if _ichangeCol = 1 then			LayoutchangeHistory[1][1] = LayoutRevHistory[1][1]		else			LayoutchangeHistory[1][_ichangeCol] = ""		endif	next _ichangeColendifif not(_bEmptyLayoutRevHistory) then	ROW_PHASE_PART = 2 !Стадия	ROW_DATE = 8 !Дата изма	ROW_IZM_N_DOC = 6 !Номер документа	ROW_IZM_SUR = 7 !Фамилия изменяющего	ROW_FAM_START_ISSUE = 0 !Начало штампа выпуска	ROW_FAM_END_ISSUE = 0 !Конец штампа выпуска	ROW_FAM_START_CHANGE = 0 !Начало штампа изменений	ROW_FAM_END_CHANGE = 0 !Конец штампа изменений	ROW_FAM_START_LAYUOT = 0 !Начало штампа макета	ROW_FAM_END_LAYUOT = 0 !Конец штампа макета	ROW_FAM_START_AGREED = 0 !Начало согласований	ROW_FAM_END_AGREED = 0 !Конец согласований	tis_position = is_position	tis_autosign = is_autosign	tis_fam = 1	tis_date = 1	for i = 1 to vardim2(GlobIssueScheme)		if STRSTR(GlobIssueScheme[1][i], "!!НАЧАЛО ШТАМПА!!") then ROW_FAM_START_ISSUE = i+1		if STRSTR(GlobIssueScheme[1][i], "!!КОНЕЦ ШТАМПА!!") then ROW_FAM_END_ISSUE = i-1		if STRSTR(GlobIssueScheme[1][i], "!!СОГЛАСОВАНО!!") then ROW_FAM_START_AGREED = i+1		if STRSTR(GlobIssueScheme[1][i], "!!КОНЕЦ СОГЛАСОВАНО!!") then ROW_FAM_END_AGREED = i-1		if STRSTR(GlobIssueScheme[1][i], "Должности (ДА/НЕТ)")>0 then			if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then tis_position = 0		endif		if STRSTR(GlobIssueScheme[1][i], "Подписи (ДА/НЕТ)")>0 then			if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then tis_autosign = 0		endif		if STRSTR(GlobIssueScheme[1][i], "Фамилии (ДА/НЕТ)")>0 then			if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then tis_fam = 0		endif		if STRSTR(GlobIssueScheme[1][i], "Дата (ДА/НЕТ)")>0 then			if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then tis_date = 0		endif	next i	!Изменения	for i = 1 to vardim2(GlobchangeScheme)		if STRSTR(GlobchangeScheme[1][i], "!!НАЧАЛО ИЗМ. 0!!") then ROW_FAM_START_CHANGE = i+2		if STRSTR(GlobchangeScheme[1][i], "!!КОНЕЦ ИЗМ. 0!!") then ROW_FAM_END_CHANGE = i-1		if STRSTR(GlobchangeScheme[1][i], "Должности (ДА/НЕТ)")>0 then			if STRSTR(LayoutchangeHistory[1][i], "НЕТ", 1)>0 then tis_position = 0		endif		if STRSTR(GlobchangeScheme[1][i], "Подписи (ДА/НЕТ)")>0 then			if STRSTR(LayoutchangeHistory[1][i], "НЕТ", 1)>0 then tis_autosign = 0		endif		if STRSTR(GlobchangeScheme[1][i], "Фамилии (ДА/НЕТ)")>0 then			if STRSTR(LayoutchangeHistory[1][i], "НЕТ", 1)>0 then tis_fam = 0		endif		if STRSTR(GlobchangeScheme[1][i], "Дата (ДА/НЕТ)")>0 then			if STRSTR(LayoutchangeHistory[1][i], "НЕТ", 1)>0 then tis_date = 0		endif	next i	ROW_FAM_START_LAYUOT = ROW_FAM_END_CHANGE-2	ROW_FAM_END_LAYUOT = ROW_FAM_START_AGREED-1	ROW_DATE = ROW_FAM_START_CHANGE-3 !Дата изма	ROW_IZM_SUR = ROW_FAM_START_CHANGE-4 !Фамилия изменяющего	ROW_IZM_N_DOC = ROW_FAM_START_CHANGE-5 !Номер документа	!---------------------- Поиск изм. 0 ------------------------		zero_change_inx = 0 : flag = 0	for i = 1 to last_change_inx		if STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], "Изм 0") then			zero_change_inx = i			if flag = 1 then				txt = "У макета должен быть только один Изм 0."				gosub "write_error"			else				flag = 1			endif		endif	next i	!------------------------------------------------------------	if zero_change_inx then		phase_part = LayoutchangeHistory[zero_change_inx][ROW_PHASE_PART]		current_phase = "" : current_part = "" : current_type = "" : current_nizm = 0			phase_part_tmp = phase_part		pos = STRSTR (phase_part_tmp, " ")-1		current_phase = STRSUB(phase_part_tmp,1,pos)		phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))		pos = STRSTR (phase_part_tmp, " ")-1		current_part = STRSUB(phase_part_tmp,1,pos)		phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))		pos = STRSTR (phase_part_tmp, " ")-1		current_type = STRSUB(phase_part_tmp,1,pos)		phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))		current_nizm = phase_part_tmp		if current_phase = "" or current_part = "" or current_type = "" then 			txt = "Проверьте название -" + phase_part			gosub "write_error"		else			if current_type<>"Изм" and current_type<>"Зам" and current_type<>"Нов" then				txt = "Может быть только Изм/Зам/Нов" + phase_part				gosub "write_error"			endif		endif		if strlen(current_phase)>3 then			txt = "Слишком длинное название стадии."			gosub "write_error"		endif		current_date = LayoutchangeHistory[zero_change_inx][ROW_DATE]	else		txt = "Добавьте Изм 0"		gosub "write_error"	endif	if zero_change_inx>0 then		!----- Переписываем должности, фамилии, даты в штамп --------		!ГИПа, РукОтдела и Нормоконтроля берём из нулевого изма (LayoutchangeHistory)		!При этом отдельно выделяем последнюю позицию - её положение настраивается в штампе		n_position = 0		if sort=1 then			gosub "from_layout"			gosub "from_change"			gosub "from_issue"		endif		if sort=0 then			gosub "from_change"			gosub "from_layout"			gosub "from_issue"		endif		if sort=2 then			n_position = 0			flag = 0			for i = ROW_FAM_START_ISSUE to ROW_FAM_END_ISSUE				n_position = n_position + 1				position_info[n_position][1] = GlobIssueScheme[1][i]				position_info[n_position][2] = ""				position_info[n_position][3] = ""			next i			for i = ROW_FAM_START_ISSUE to ROW_FAM_END_ISSUE				if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then					for j=1 to n_position						if position_info[j][1] = GlobIssueScheme[1][i] then							position_info[j][2] = LayoutRevHistory[last_rev_inx][i]							position_info[j][3] = current_date						endif					next j				endif			next i			for i = ROW_FAM_START_CHANGE to ROW_FAM_END_CHANGE				if STRLEN(LayoutchangeHistory[zero_change_inx][i])>1 then  !Если указана фамилия - записываем					for j=1 to n_position						if position_info[j][1] = GlobchangeScheme[1][i] then							position_info[j][2] = LayoutchangeHistory[zero_change_inx][i]							position_info[j][3] = current_date						endif					next j				endif			next i			for i = ROW_FAM_START_LAYUOT to ROW_FAM_END_LAYUOT				if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then					for j=1 to n_position						if position_info[j][1] = GlobIssueScheme[1][i] then							position_info[j][2] = LayoutRevHistory[last_rev_inx][i]							position_info[j][3] = current_date						endif					next j				endif			next i		endif		!------------------------------------------------------------		!-------- Заполнение граф согласований -------------------------		n_position_agreed = 0		for i = ROW_FAM_START_AGREED to ROW_FAM_END_AGREED			if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then !Если указана фамилия - записываем				n_position_agreed = n_position_agreed + 1				agreed_info[n_position_agreed][1] = GlobIssueScheme[1][i]				agreed_info[n_position_agreed][2] = LayoutRevHistory[last_rev_inx][i]				agreed_info[n_position_agreed][3] = current_date			endif		next i		!------------------------------------------------------------		!---------------------- Для КЖИ -----------------------------		for i = ROW_FAM_END_AGREED to vardim2(GlobIssueScheme)			if STRSTR(GlobIssueScheme[1][i], "Масса")>0 then weight = LayoutRevHistory[last_rev_inx][i]			if STRSTR(GlobIssueScheme[1][i], "Имя сборки")>0 then subpos = LayoutRevHistory[last_rev_inx][i]			if STRSTR(GlobIssueScheme[1][i], "Шифр")>0 then shifrt_l = LayoutRevHistory[last_rev_inx][i]		next i		if vartype(weight)=1 then weight = STR("%.2",weight)		if vartype(subpos)=1 then subpos = STR("%.0",subpos)		if vartype(shifrt_l)=1 then shifrt_l = STR("%.0",shifrt_l)		!------------------------------------------------------------		!-------- Заполнение граф изменений -------------------------		start = 8		for i = 1 to last_change_inx			not_zero = (STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], "Изм 0") = 0)			comp_phase = (STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], current_phase) > 0)			comp_part = (STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], current_part) > 0)			not_sys = (STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], "!") = 0)			if not_zero and comp_phase and comp_part and not_sys then				phase_part = LayoutchangeHistory[i][ROW_PHASE_PART]				t_phase = "" : t_part = "" : t_type = "" : t_nizm = ""				phase_part_tmp = phase_part				pos = STRSTR (phase_part_tmp, " ")-1				t_phase = STRSUB(phase_part_tmp,1,pos)				phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))				pos = STRSTR (phase_part_tmp, " ")-1				t_part = STRSUB(phase_part_tmp,1,pos)				phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))				pos = STRSTR (phase_part_tmp, " ")-1				t_type = STRSUB(phase_part_tmp,1,pos)				phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))				t_nizm = phase_part_tmp				if t_phase = "" or t_part = "" or t_type = "" or t_nizm = "" then 					txt = "Проверьте название -" + phase_part					gosub "write_error"				else					if t_type<>"Изм" and t_type<>"Зам" and t_type<>"Нов" then						txt = "Может быть только Изм/Зам/Нов" + phase_part						gosub "write_error"					endif				endif				if n_err=0 then					n_izm = n_izm + 1					change_info[n_izm][1] = t_nizm					change_info[n_izm][2] = t_type					change_info[n_izm][3] = LayoutchangeHistory[i][ROW_IZM_N_DOC]					change_info[n_izm][4] = LayoutchangeHistory[i][ROW_IZM_SUR]					change_info[n_izm][5] = LayoutchangeHistory[i][ROW_DATE]					tend_date = LayoutchangeHistory[i][ROW_DATE]					if STRSTR(t_type, "Зам") or STRSTR(t_type, "Нов") then 						change_info[n_izm][6] = "-"					else						change_info[n_izm][6] = " "					endif					if STRSTR(t_type, "Изм") then change_info[n_izm][2] = "-"				endif			endif			if (not(comp_phase) or not(comp_part)) and not_zero and not_sys then				txt = "У всех изменений макеты должны совпадать стадии и разделы"				gosub "write_error"			endif		next i		if not(n_izm) then 			_bfirstchange = 1		else		! -- Поиск совпадающий измов			for i = 1 to vardim1(change_info)				for j = 1 to vardim1(change_info)					if j<>i and	change_info[i][1] = change_info[j][1] then						txt = "Сопадающие номера изменений - " + change_info[j][1] + " " + change_info[j][2]						gosub "write_error"					endif				next j			next i		endif		!------------------------------------------------------------		if debug then			add2 0.1,0			arr2 = GlobIssueScheme : gosub "pr_2arr"			add2 0.1,0			arr2 = LayoutRevHistory : gosub "pr_2arr"			add2 0.1,0			arr2 = GlobchangeScheme : gosub "pr_2arr"			add2 0.1,0			arr2 = LayoutchangeHistory : gosub "pr_2arr"		endif	endifelse	txt = "Добавьте Изм 0"	gosub "write_error"endifdel top!-------------- Сортировка массива с изменениями ---------------if (type_sort_issue=1 or type_sort_issue=2) and n_err=0 then !По номеру изма.	n_col = 1	dim sort_arr[]	for i=1 to n_izm		var = change_info[i][n_col]		if vartype(var)=2 then			rez = SPLIT(var,"%n",var_num)			var = var_num		endif		if vartype(var)=1 then			sort_arr[i] = var		else			sort_arr[i] = 0			txt = "Номер изменения должно быть числом -" + var			gosub "write_error"		endif	next i	for j=1 to n_izm		flag_end=1		for i=1 TO n_izm-j			flag_swap = 0			if type_sort_issue=1 then flag_swap = (sort_arr[i]<sort_arr[i+1])			if type_sort_issue=2 then flag_swap = (sort_arr[i]>sort_arr[i+1])			if flag_swap then				kk = sort_arr[i]				sort_arr[i] = sort_arr[i+1]				sort_arr[i+1] = kk				flag_end=0			endif		next i		if flag_end then j=n_izm	next j	dim sort_arr_t[][]	for j=1 to n_izm		izm = sort_arr[j]		for i=1 to n_izm			var = change_info[i][n_col]			if vartype(var)=2 then				rez = SPLIT(var,"%n",var_num)				var = var_num			endif			if vartype(var)=1 then				if var = izm then					for k=1 to vardim2(change_info)						sort_arr_t[j][k] = change_info[i][k]					next k					i=n_izm				endif			endif		next i	next j	change_info = sort_arr_tendif!-------------- Сортировка массива с изменениями ---------------arr1 = error : gosub "pr_1arr"if n_err > 0 then _bERROR = 1goto 20"pr_2arr":	k=0	for i = 1 to vardim1(arr2)		for j = 1 to vardim2(arr2)			text2 0,-0.01*k,arr2[i][j]			text2 -0.01,-0.01*k,i			text2 -0.02,-0.01*k,j			k = k+1		next j	next ireturn"pr_1arr":	k=0	for i = 1 to vardim1(arr1)			text2 0,-0.01*k,arr1[i]			text2 -0.01,-0.01*k,i			k = k+1	next ireturn"write_error":	n_err = n_err + 1	error[n_err] = txtreturn"from_layout":	for i = ROW_FAM_START_LAYUOT to ROW_FAM_END_LAYUOT		if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then			flag = 1			for j = 1 to n_position				if GlobIssueScheme[1][i]= position_info[j][1] then flag = 0			next j			if flag then				n_position = n_position + 1				position_info[n_position][1] = GlobIssueScheme[1][i]				position_info[n_position][2] = LayoutRevHistory[last_rev_inx][i]				position_info[n_position][3] = current_date			endif		endif	next ireturn"from_issue":	for i = ROW_FAM_START_ISSUE to ROW_FAM_END_ISSUE		if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then			flag = 1			for j = 1 to n_position				if GlobIssueScheme[1][i]= position_info[j][1] then flag = 0			next j			if flag then				n_position = n_position + 1				position_info[n_position][1] = GlobIssueScheme[1][i]				position_info[n_position][2] = LayoutRevHistory[last_rev_inx][i]				position_info[n_position][3] = current_date			endif		endif	next ireturn"from_change":	for i = ROW_FAM_START_CHANGE to ROW_FAM_END_CHANGE		if STRLEN(LayoutchangeHistory[zero_change_inx][i])>1 then			flag = 1			for j = 1 to n_position				if GlobchangeScheme[1][i]= position_info[j][1] then flag = 0			next j			if flag then				n_position = n_position + 1				position_info[n_position][1] = GlobchangeScheme[1][i]				position_info[n_position][2] = LayoutchangeHistory[zero_change_inx][i]				position_info[n_position][3] = current_date			endif		endif	next ireturn20: