r184 = 2.34
DEFINE STYLE "текст25-1"  fontType, r255, 1, rtype
DEFINE STYLE "текст25-3"  fontType, r255, 3, rtype
DEFINE STYLE "текст25-5"  fontType, r255, 5, r255type
DEFINE STYLE "текст18-4"  fontType, r184, 4, r184type
DEFINE STYLE "текст18-5"  fontType, r184, 5, r184type
DEFINE STYLE "текст18-1"  fontType, r184, 1, r184type
DEFINE STYLE "текст20-5"  fontType, r205, 5, r205type
DEFINE STYLE "текст20-1"  fontType, r205, 1, r205type
DEFINE STYLE "текст20-4"  fontType, r205, 4, r205type
DEFINE STYLE "текст50-5"  fontType, r505, 5, r505type

DEFINE STYLE{2} "текст18-5-2" fontType, r184*100, r184type
DEFINE STYLE "date" fontType, 0.5, 7, 0
n = REQUEST ("HomeDB_info", "", homeDBIntId, homeDBUserId, homeDBName, homeContext)
if homeContext<>5 then
	is_num = 0
else
	n1= SPLIT (homeDBUserId, "%n", curren_ID)
	if diff_type_table then
		if homeDBUserId = "1" then
			type_table = type_table_first

		else
			type_table = type_table_next
		endif
	endif
endif

if vardim2(GLOB_ISSUE_SCHEME) > 0 then
	! global exists
	GlobIssueScheme	= GLOB_ISSUE_SCHEME
else
	_bEmptyGlobIssues = 1
endif

if vardim2(GLOB_change_SCHEME) > 0 then
	! global exists
	GlobchangeScheme = GLOB_change_SCHEME
else
	_bEmptyGlobchanges = 1
endif

if GLOB_SCRIPT_TYPE = 2 then
	_bLayoutContext = (GLOB_CONTEXT = 8 | GLOB_CONTEXT = 28)
	if _bLayoutContext then
		! Layout context or Layout Editing feedback: use globals from Issue Manager
		LayoutRevHistory = LAYOUT_REVISION_HISTORY
		LayoutchangeHistory	= LAYOUT_change_HISTORY
		last_change_inx = vardim1(LayoutchangeHistory)
		last_rev_inx = vardim1(LayoutRevHistory)
		if vardim2(LayoutRevHistory) > 1 then
			if STRSTR(LayoutRevHistory[last_rev_inx][3], "Отсутствует в Выпуске") then 
				txt = "Макет добавлен в выпуск?"
				gosub "write_error"
			endif
		else
			txt = "Макет добавлен в выпуск?"
			gosub "write_error"
		endif
	else
		text2 0.05, 0.05,  "!! Работает только на макетах !!"
	endif
endif
if vardim2(LayoutRevHistory) <> vardim2(GlobIssueScheme) then
	! if global exists, must have same number of columns as GLOB_ISSUE_SCHEME
	_bEmptyLayoutRevHistory = 1
endif
if vardim2(LayoutchangeHistory) <> vardim2(GlobchangeScheme) then
	! if global exists, must have same number of columns as GLOB_change_SCHEME
	_bEmptyLayoutChHistory = 1
endif
if not(_bEmptyLayoutRevHistory) & _bEmptyLayoutChHistory then
	! if has revision data but no change attached, create 1 dummy empty change row
	for _ichangeCol = 1 to vardim2(GLOB_change_SCHEME)
		if _ichangeCol = 1 then
			LayoutchangeHistory[1][1] = LayoutRevHistory[1][1]
		else
			LayoutchangeHistory[1][_ichangeCol] = ""
		endif
	next _ichangeCol
endif

if not(_bEmptyLayoutRevHistory) then

	ROW_PHASE_PART = 2 !Стадия
	ROW_DATE = 8 !Дата изма
	ROW_IZM_N_DOC = 6 !Номер документа
	ROW_IZM_SUR = 7 !Фамилия изменяющего

	ROW_FAM_START_ISSUE = 0 !Начало штампа выпуска
	ROW_FAM_END_ISSUE = 0 !Конец штампа выпуска
	ROW_FAM_START_CHANGE = 0 !Начало штампа изменений
	ROW_FAM_END_CHANGE = 0 !Конец штампа изменений
	ROW_FAM_START_LAYUOT = 0 !Начало штампа макета
	ROW_FAM_END_LAYUOT = 0 !Конец штампа макета
	ROW_FAM_START_AGREED = 0 !Начало согласований
	ROW_FAM_END_AGREED = 0 !Конец согласований
	ROW_FIRST_N_SHEET = 0

	ROW_REDACT = 0
	ROW_REDACT_NAME = 0
	ROW_REDACT_DATE = 0
	ROW_CLEAR_AFD = 0

	tis_position = is_position
	tis_autosign = is_autosign
	tis_fam = 1
	tis_date = 1
	tis_RVI = 0

	for i = 1 to vardim2(GlobIssueScheme)
		if STRSTR(GlobIssueScheme[1][i], "!!НАЧАЛО ШТАМПА!!", 1) then ROW_FAM_START_ISSUE = i+1
		if STRSTR(GlobIssueScheme[1][i], "!!КОНЕЦ ШТАМПА!!", 1) then ROW_FAM_END_ISSUE = i-1
		if STRSTR(GlobIssueScheme[1][i], "!!СОГЛАСОВАНО!!", 1) then ROW_FAM_START_AGREED = i+1
		if STRSTR(GlobIssueScheme[1][i], "!!КОНЕЦ СОГЛАСОВАНО!!", 1) then ROW_FAM_END_AGREED = i-1
		if STRSTR(GlobIssueScheme[1][i], "Должности (ДА/НЕТ)", 1)>0 then
			if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then tis_position = 0
			if STRSTR(LayoutRevHistory[1][i], "ДА", 1)>0 then tis_position = 1
		endif
		if STRSTR(GlobIssueScheme[1][i], "Подписи (ДА/НЕТ)", 1)>0 then
			if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then tis_autosign = 0
			if STRSTR(LayoutRevHistory[1][i], "ДА", 1)>0 then tis_autosign = 1
		endif
		if STRSTR(GlobIssueScheme[1][i], "Фамилии (ДА/НЕТ)", 1)>0 then
			if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then tis_fam = 0
			if STRSTR(LayoutRevHistory[1][i], "ДА", 1)>0 then tis_fam = 1
		endif
		if STRSTR(GlobIssueScheme[1][i], "Дата (ДА/НЕТ)", 1)>0 then
			if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then tis_date = 0
			if STRSTR(LayoutRevHistory[1][i], "ДА", 1)>0 then tis_date = 1
		endif
		if STRSTR(GlobIssueScheme[1][i], "Номера листов (ДА/НЕТ)", 1)>0 then
			if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then sheet_id = ""
		endif
		if STRSTR(GlobIssueScheme[1][i], "Инв. номер", 1)>0 then
			if STRSTR(GlobIssueScheme[1][i], "Инв. номер (ДА/НЕТ)", 1)>0 then
				if STRSTR(LayoutRevHistory[1][i], "НЕТ", 1)>0 then is_invno = 0
				if STRSTR(LayoutRevHistory[1][i], "ДА", 1)>0 then is_invno = 1
			else
				if STRLEN(LayoutRevHistory[1][i])>0 then
					inv_no = LayoutRevHistory[1][i]
					if vartype(inv_no)=1 then inv_no = STR("%.0",inv_no)
				endif
			endif
		endif
		if STRSTR(GlobIssueScheme[1][i], "Набор правил", 1)>0 then
			if STRLEN(LayoutRevHistory[1][i])>0 then
				rule_name = LayoutRevHistory[1][i]
				if vartype(rule_name)=1 then rule_name = STR("%.0", rule_name)
			endif
		endif
		if STRSTR(GlobIssueScheme[1][i], "Шифр", 1)>0 then
			if STRLEN(LayoutRevHistory[1][i])>0 then
				shifrt_l = LayoutRevHistory[1][i]
				if vartype(shifrt_l)=1 then shifrt_l = STR("%.0",shifrt_l)
			endif
		endif

		if STRSTR(GlobIssueScheme[1][i], "Суффикс", 1)>0 then
			if STRLEN(LayoutRevHistory[1][i])>0 then
				suff = LayoutRevHistory[1][i]
				if vartype(suff)=1 then suff = STR("%.0",suff)
			endif
		endif
		if STRSTR(GlobIssueScheme[1][i], "Префикс", 1)>0 then
			if STRLEN(LayoutRevHistory[1][i])>0 then
				pref = LayoutRevHistory[1][i]
				if vartype(pref)=1 then pref = STR("%.0",pref)
			endif
		endif
		if STRSTR(GlobIssueScheme[1][i], "Somestuff_QtyIssue_", 1) then
			somestuff_row_inx[vardim1(somestuff_row_inx)+1] = i
		endif
		if STRSTR(GlobIssueScheme[1][i], "Somestuff_Layout_Type", 1)>0 then
			if STRSTR(LayoutRevHistory[1][i], "РВИ", 1)>0 then tis_RVI = 1
		endif
	next i

	!Изменения
	ROW_ISPOSITION = 0	!Название должности вкл/выкл
	ROW_ISAUTOSUGN = 0	!Подпись вкл/выкл
	ROW_ISFAM = 0		!Фамилия вкл/выкл
	ROW_ISDATA = 0		!Дата вкл/выкл
	ROW_ISSHEETID = 0	!Номер листа вкл/выкл
	ROW_SHIFR = 0		!Шифр
	ROW_INVNO = 0		!Инвентарный номер
	ROW_ISINVNO = 0		!Инвентарный номер вкл/выкл
	ROW_SUFF = 0			!Суффикс шифра
	ROW_PREFF = 0		!Префикс шифра
	ROW_RULESNAME = 0	!Имя правил (пусто или СНХП)

	for i = 1 to vardim2(GlobchangeScheme)
		if STRSTR(GlobchangeScheme[1][i], "!!НАЧАЛО ИЗМ. 0!!", 1) then ROW_FAM_START_CHANGE = i+2
		if STRSTR(GlobchangeScheme[1][i], "!!КОНЕЦ ИЗМ. 0!!", 1) then ROW_FAM_END_CHANGE = i-1
		if STRSTR(GlobchangeScheme[1][i], "Должности (ДА/НЕТ)", 1)>0 then ROW_ISPOSITION = i
		if STRSTR(GlobchangeScheme[1][i], "Подписи (ДА/НЕТ)", 1)>0 then ROW_ISAUTOSUGN = i
		if STRSTR(GlobchangeScheme[1][i], "Фамилии (ДА/НЕТ)", 1)>0 then ROW_ISFAM = i
		if STRSTR(GlobchangeScheme[1][i], "Дата (ДА/НЕТ)", 1)>0 then ROW_ISDATA = i
		if STRSTR(GlobchangeScheme[1][i], "Шифр", 1)>0 then ROW_SHIFR = i
		if STRSTR(GlobchangeScheme[1][i], "Номера листов (ДА/НЕТ)", 1)>0 then ROW_ISSHEETID = i
		if STRSTR(GlobchangeScheme[1][i], "Инв. номер", 1)>0 then 
			if STRSTR(GlobchangeScheme[1][i], "Инв. номер (ДА/НЕТ)", 1)>0 then 
				ROW_ISINVNO = i
			else
				ROW_INVNO = i
			endif
		endif
		if STRSTR(GlobchangeScheme[1][i], "Суффикс", 1)>0 then ROW_SUFF = i
		if STRSTR(GlobchangeScheme[1][i], "Префикс", 1)>0 then ROW_PREFF = i
		if STRSTR(GlobchangeScheme[1][i], "Набор правил", 1)>0 then ROW_RULESNAME = i
		if STRSTR(GlobchangeScheme[1][i], "Редакция", 1)>0 then ROW_REDACT = i
		if STRSTR(GlobchangeScheme[1][i], "Цель выпуска", 1)>0 then ROW_REDACT_NAME = i
		if STRSTR(GlobchangeScheme[1][i], "Дата выпуска редакции", 1)>0 then ROW_REDACT_DATE = i
		if STRSTR(GlobchangeScheme[1][i], "Номер первого листа", 1)>0 then ROW_FIRST_N_SHEET = i
		if STRSTR(GlobchangeScheme[1][i], "Убрать IFR (ДА/НЕТ)", 1)>0 then ROW_CLEAR_AFD = i
	next i
	ROW_FAM_START_LAYUOT = ROW_FAM_END_CHANGE-2
	ROW_FAM_END_LAYUOT = ROW_FAM_START_AGREED-1

	ROW_DATE = ROW_FAM_START_CHANGE-3 !Дата изма
	ROW_IZM_SUR = ROW_FAM_START_CHANGE-4 !Фамилия изменяющего
	ROW_IZM_N_DOC = ROW_FAM_START_CHANGE-5 !Номер документа
	
	!---------------------- Поиск изм. 0 ------------------------	
	zero_change_inx = 0 : flag = 0
	for i = 1 to last_change_inx
		if STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], "Изм 0", 1) then
			zero_change_inx = i
			if flag = 1 then
				txt = "У макета должен быть только один Изм 0."
				gosub "write_error"
			else
				flag = 1
			endif
		endif
	next i
	!------------------------------------------------------------
	if zero_change_inx then
		if ROW_ISPOSITION>0 then
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISPOSITION], "НЕТ", 1)>0 then tis_position = 0
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISPOSITION], "ДА", 1)>0 then tis_position = 1
		endif
		if ROW_ISAUTOSUGN>0 then
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISAUTOSUGN], "НЕТ", 1)>0 then tis_autosign = 0
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISAUTOSUGN], "ДА", 1)>0 then tis_autosign = 1
		endif
		if ROW_ISFAM>0 then
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISFAM], "НЕТ", 1)>0 then tis_fam = 0
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISFAM], "ДА", 1)>0 then tis_fam = 1
		endif
		if ROW_ISDATA>0 then
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISDATA], "НЕТ", 1)>0 then tis_date = 0
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISDATA], "ДА", 1)>0 then tis_date = 1
		endif
		if ROW_SHIFR>0 then
			if STRLEN(LayoutchangeHistory[zero_change_inx][ROW_SHIFR])>0 then
				shifrt_l = LayoutchangeHistory[zero_change_inx][ROW_SHIFR]
				if vartype(shifrt_l)=1 then shifrt_l = STR("%.0",shifrt_l)
			endif
		endif
		if ROW_ISSHEETID>0 then
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISSHEETID], "НЕТ", 1)>0 then sheet_id = ""
		endif
		if ROW_ISINVNO>0 then
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISINVNO], "НЕТ", 1)>0 then is_invno = 0
			if STRSTR(LayoutchangeHistory[zero_change_inx][ROW_ISINVNO], "ДА", 1)>0 then is_invno = 1
		endif
		if ROW_INVNO>0 then
			if STRLEN(LayoutchangeHistory[zero_change_inx][ROW_INVNO])>0 then
				inv_no = LayoutchangeHistory[zero_change_inx][ROW_INVNO]
				if vartype(inv_no)=1 then inv_no = STR("%.0",inv_no)
			endif
		endif
		if ROW_SUFF>0 then
			if STRLEN(LayoutchangeHistory[zero_change_inx][ROW_SUFF])>0 then
				suff = LayoutchangeHistory[zero_change_inx][ROW_SUFF]
				if vartype(suff)=1 then suff = STR("%.0",suff)
			endif
		endif
		if ROW_PREFF>0 then
			if STRLEN(LayoutchangeHistory[zero_change_inx][ROW_PREFF])>0 then
				pref = LayoutchangeHistory[zero_change_inx][ROW_PREFF]
				if vartype(pref)=1 then pref = STR("%.0",pref)
			endif
		endif
		if ROW_RULESNAME>0 then
			if STRLEN(LayoutchangeHistory[zero_change_inx][ROW_RULESNAME])>0 then
				rule_name = LayoutchangeHistory[zero_change_inx][ROW_RULESNAME]
				if vartype(rule_name)=1 then rule_name = STR("%.0", rule_name)
			endif
		endif
		phase_part = LayoutchangeHistory[zero_change_inx][ROW_PHASE_PART]
		current_phase = "" : current_part = "" : current_type = "" : current_nizm = 0	
		phase_part_tmp = phase_part
		pos = STRSTR (phase_part_tmp, " ")-1
		current_phase = STRSUB(phase_part_tmp,1,pos)
		phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))
		pos = STRSTR (phase_part_tmp, " ")-1
		current_part = STRSUB(phase_part_tmp,1,pos)
		phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))
		pos = STRSTR (phase_part_tmp, " ")-1
		current_type = STRSUB(phase_part_tmp,1,pos)
		phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))
		current_nizm = phase_part_tmp
		if current_phase = "" or current_part = "" or current_type = "" then 
			txt = "Проверьте название -" + phase_part
			gosub "write_error"
		else
			if current_type<>"Изм" and current_type<>"Зам" and current_type<>"Нов" then
				txt = "Может быть только Изм/Зам/Нов" + phase_part
				gosub "write_error"
			endif
		endif
		if strlen(current_phase)>3 then
			txt = "Слишком длинное название стадии."
			gosub "write_error"
		endif
		current_date = LayoutchangeHistory[zero_change_inx][ROW_DATE]
	else
		txt = "Добавьте Изм 0"
		gosub "write_error"
	endif
	if zero_change_inx>0 then
		!----- Переписываем должности, фамилии, даты в штамп --------
		!ГИПа, РукОтдела и Нормоконтроля берём из нулевого изма (LayoutchangeHistory)
		!При этом отдельно выделяем последнюю позицию - её положение настраивается в штампе
		n_position = 0
		if sort=1 then
			gosub "from_layout"
			gosub "from_change"
			gosub "from_issue"
		endif
		if sort=0 then
			gosub "from_change"
			gosub "from_layout"
			gosub "from_issue"
		endif
		if sort=2 then
			n_position = 0
			flag = 0
			for i = ROW_FAM_START_ISSUE to ROW_FAM_END_ISSUE
				n_position = n_position + 1
				position_info[n_position][1] = GlobIssueScheme[1][i]
				position_info[n_position][2] = ""
				position_info[n_position][3] = ""
			next i
			for i = ROW_FAM_START_ISSUE to ROW_FAM_END_ISSUE
				if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then
					for j=1 to n_position
						if position_info[j][1] = GlobIssueScheme[1][i] then
							position_info[j][2] = LayoutRevHistory[last_rev_inx][i]
							position_info[j][3] = current_date
						endif
					next j
				endif
			next i
			for i = ROW_FAM_START_CHANGE to ROW_FAM_END_CHANGE
				if STRLEN(LayoutchangeHistory[zero_change_inx][i])>1 then  !Если указана фамилия - записываем
					for j=1 to n_position
						if position_info[j][1] = GlobchangeScheme[1][i] then
							position_info[j][2] = LayoutchangeHistory[zero_change_inx][i]
							position_info[j][3] = current_date
						endif
					next j
				endif
			next i
			for i = ROW_FAM_START_LAYUOT to ROW_FAM_END_LAYUOT
				if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then
					for j=1 to n_position
						if position_info[j][1] = GlobIssueScheme[1][i] then
							position_info[j][2] = LayoutRevHistory[last_rev_inx][i]
							position_info[j][3] = current_date
						endif
					next j
				endif
			next i
		endif

		!В макете, в свойствах, есть записьв формате
		!ID изменения@Кол-во участков@Тип изменения@Фамилия
		if vardim1(somestuff_row_inx)>0 then
			for i = 1 to vardim1(somestuff_row_inx)
				somestuff_row_data[i][1] = ""
				somestuff_row_data[i][2] = ""
				somestuff_row_data[i][3] = ""
				somestuff_row_data[i][4] = ""
				inx_row = somestuff_row_inx[i]
				if inx_row>0 and inx_row<=vardim2(LayoutRevHistory) then
					if strstr(LayoutRevHistory[last_rev_inx][inx_row], "@")>0 then
						use_addon = 1
						strrev = LayoutRevHistory[last_rev_inx][inx_row]
						pos = STRSTR (strrev , "@")-1
						somestuff_row_data[i][1] = STRSUB(strrev ,1,pos) !ID изменения
						strrev = STRSUB(strrev,pos+2,STRLEN(strrev))
						pos = STRSTR (strrev , "@")-1
						somestuff_row_data[i][2] = STRSUB(strrev ,1,pos) !Кол-во участков
						if somestuff_row_data[i][2]="0" then somestuff_row_data[i][2] = ""
						strrev = STRSUB(strrev,pos+2,STRLEN(strrev))
						tipe_izzm = "" : fam = ""
						if (STRSTR (strrev,"@"))>0 then
							pos = STRSTR (strrev , "@")-1
							tipe_izzm = STRSUB(strrev,1,pos)
							fam = STRSUB(strrev,pos+2,STRLEN(strrev))
						else	
							fam = strrev
						endif
						if strlen(fam)<5 and (strstr(fam,"изм",1) or strstr(fam,"зам",1) or strstr(fam,"нов",1) or strstr(fam,"аннул",1)) then
							tipe_izzm = fam
							fam = ""
						endif
						somestuff_row_data[i][3] = tipe_izzm
						somestuff_row_data[i][4] = fam
					endif
				endif
			next i
		endif

		if ROW_FIRST_N_SHEET>0 then n = SPLIT (LayoutChangeHistory[zero_change_inx][ROW_FIRST_N_SHEET], "%n", first_N_sheet)
		if ROW_REDACT>0 and ROW_REDACT_NAME>0 and ROW_REDACT_DATE>0 and ROW_CLEAR_AFD>0 then
			if strlen(LayoutchangeHistory[zero_change_inx][ROW_REDACT_NAME])>0 then
				n_izm_dop = n_izm_dop + 1
				redact_name = LayoutchangeHistory[zero_change_inx][ROW_REDACT_NAME]
				if strstr(redact_name, "IFR")>0 then redact_name = "IFR - Issued for review / Выпущено для рассмотрения"
				if strstr(redact_name, "AFD")>0 then redact_name = "AFD - Approved for design / Утвержден для проектирования"
				if strlen(redact_name)=0 then redact_name = ""
				redact_date = LayoutchangeHistory[zero_change_inx][ROW_REDACT_DATE]
				if strlen(redact_date)=0 then redact_date = ""
				change_info_dop[n_izm_dop][1] = "0"
				change_info_dop[n_izm_dop][2] = "Изм."
				change_info_dop[n_izm_dop][3] = redact_date
				change_info_dop[n_izm_dop][4] = redact_name 
				if strstr(LayoutchangeHistory[zero_change_inx][ROW_CLEAR_AFD], "Да")>0 then hide_ifr = 1
			endif
		endif
		!------------------------------------------------------------
		!-------- Заполнение граф согласований -------------------------
		n_position_agreed = 0
		for i = ROW_FAM_START_AGREED to ROW_FAM_END_AGREED
			if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then !Если указана фамилия - записываем
				n_position_agreed = n_position_agreed + 1
				agreed_info[n_position_agreed][1] = GlobIssueScheme[1][i]
				agreed_info[n_position_agreed][2] = LayoutRevHistory[last_rev_inx][i]
				agreed_info[n_position_agreed][3] = current_date
			endif
		next i
		!------------------------------------------------------------
		for i = ROW_FAM_END_AGREED to vardim2(GlobIssueScheme)
			if STRSTR(GlobIssueScheme[1][i], "Масса")>0 then weight = LayoutRevHistory[last_rev_inx][i]
			if STRSTR(GlobIssueScheme[1][i], "Имя сборки")>0 then subpos = LayoutRevHistory[last_rev_inx][i]
			if STRSTR(GlobIssueScheme[1][i], "Шифр")>0 and strlen(LayoutRevHistory[last_rev_inx][i])>0 then shifrt_l = LayoutRevHistory[last_rev_inx][i]
			if STRSTR(GlobIssueScheme[1][i], "Суффикс")>0 then
				if STRLEN(LayoutRevHistory[1][i])>0 then
					suff = LayoutRevHistory[1][i]
					if vartype(suff)=1 then suff = STR("%.0",suff)
				endif
			endif
			if STRSTR(GlobIssueScheme[1][i], "Префикс")>0 then
				if STRLEN(LayoutRevHistory[1][i])>0 then
					pref = LayoutRevHistory[1][i]
					if vartype(pref)=1 then pref = STR("%.0",pref)
				endif
			endif
		next i
		if vartype(weight)=1 then weight = STR("%.2",weight)
		if vartype(subpos)=1 then subpos = STR("%.0",subpos)
		if vartype(shifrt_l)=1 then shifrt_l = STR("%.0",shifrt_l)
		!------------------------------------------------------------
		!-------- Заполнение граф изменений -------------------------
		start = 8
		for i = 1 to last_change_inx
			not_zero = (STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], "Изм 0") = 0)
			comp_phase = (STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], current_phase) > 0)
			comp_part = (STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], current_part) > 0)
			not_sys = (STRSTR(LayoutchangeHistory[i][ROW_PHASE_PART], "!") = 0)
			if not_zero and comp_phase and comp_part and not_sys then
				phase_part = LayoutchangeHistory[i][ROW_PHASE_PART]
				t_phase = "" : t_part = "" : t_type = "" : t_nizm = ""
				phase_part_tmp = phase_part
				pos = STRSTR (phase_part_tmp, " ")-1
				t_phase = STRSUB(phase_part_tmp,1,pos)
				phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))
				pos = STRSTR (phase_part_tmp, " ")-1
				t_part = STRSUB(phase_part_tmp,1,pos)
				phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))
				pos = STRSTR (phase_part_tmp, " ")-1
				t_type = STRSUB(phase_part_tmp,1,pos)
				phase_part_tmp = STRSUB(phase_part_tmp,pos+2,STRLEN(phase_part_tmp))
				t_nizm = phase_part_tmp
				!!Ищем подходящие данные в свойствах листа
				inx_addon = 0
				if use_addon = 1 then
					_tstr = t_phase + " " + t_part + " " + t_nizm
					for k = 1 to vardim1(somestuff_row_data)
						if (somestuff_row_data[k][1]=_tstr) then
							inx_addon = k
							k = vardim1(somestuff_row_data)
						endif
					next k
				endif
				izm_sur = LayoutchangeHistory[i][ROW_IZM_SUR]
				n_uch = " "
				if inx_addon > 0 then
					if strlen(somestuff_row_data[inx_addon][2])>0 then n_uch = somestuff_row_data[inx_addon][2]
					if strlen(somestuff_row_data[inx_addon][3])>0 then t_type = somestuff_row_data[inx_addon][3]
					if strlen(somestuff_row_data[inx_addon][4])>0 then izm_sur = somestuff_row_data[inx_addon][4]

				endif
				if t_phase = "" or t_part = "" or t_type = "" or t_nizm = "" then 
					txt = "Проверьте название -" + phase_part
					gosub "write_error"
				endif
				is_dop = 0
				if ROW_REDACT>0 and ROW_REDACT_NAME>0 and ROW_REDACT_DATE>0 then
					if strlen(LayoutchangeHistory[i][ROW_REDACT_NAME]) > 0 then is_dop = 1
				endif
				if n_err=0 and (t_type="Изм" or t_type="Зам" or t_type="Нов") and is_dop = 0 then
					n_izm = n_izm + 1
					change_info[n_izm][1] = t_nizm
					change_info[n_izm][2] = t_type
					change_info[n_izm][3] = LayoutchangeHistory[i][ROW_IZM_N_DOC]
					change_info[n_izm][4] = izm_sur
					change_info[n_izm][5] = LayoutchangeHistory[i][ROW_DATE]
					tend_date = LayoutchangeHistory[i][ROW_DATE]
					if STRSTR(t_type, "Зам") or STRSTR(t_type, "Нов") then n_uch = "-"
					if STRSTR(t_type, "Изм") then change_info[n_izm][2] = "-"
					change_info[n_izm][6] = n_uch
				endif
				if n_err=0 and is_dop = 1 then
					redact = LayoutchangeHistory[i][ROW_REDACT]
					if strlen(redact)=0 or redact="" then redact = t_nizm
					if vartype(redact)=2 then
						if strstr(redact, "0")>0 then redact = STRSUB(redact,2,STRLEN(redact))
						if strstr(redact, "0")>0 then redact = STRSUB(redact,2,STRLEN(redact))
					endif
					redact_name = LayoutchangeHistory[i][ROW_REDACT_NAME]
					if strstr(redact_name, "IFR")>0 then redact_name = "IFR - Issued for review / Выпущено для рассмотрения"
					if strstr(redact_name, "AFD")>0 then redact_name = "AFD - Approved for design / Утвержден для проектирования"
					if strlen(redact_name)=0 then redact_name = ""
					redact_date = LayoutchangeHistory[i][ROW_REDACT_DATE]
					if strlen(redact_date)=0 then redact_date = ""
					n_izm_dop = n_izm_dop + 1
					change_info_dop[n_izm_dop][1] = redact
					change_info_dop[n_izm_dop][2] = t_type
					change_info_dop[n_izm_dop][3] = redact_date
					change_info_dop[n_izm_dop][4] = redact_name 
				endif
			endif
			if (not(comp_phase) or not(comp_part)) and not_zero and not_sys then
				txt = "У всех изменений макеты должны совпадать стадии и разделы"
				gosub "write_error"
			endif
		next i
		if not(n_izm) then 
			_bfirstchange = 1
		else
		! -- Поиск совпадающий измов
			for i = 1 to vardim1(change_info)
				for j = 1 to vardim1(change_info)
					if j<>i and	change_info[i][1] = change_info[j][1] then
						txt = "Сопадающие номера изменений - " + change_info[j][1] + " " + change_info[j][2]
						gosub "write_error"
					endif
				next j
			next i
		endif
		!------------------------------------------------------------
		if debug then
			add2 0.1,0
			arr2 = GlobIssueScheme : gosub "pr_2arr"
			add2 0.1,0
			arr2 = LayoutRevHistory : gosub "pr_2arr"
			add2 0.1,0
			arr2 = GlobchangeScheme : gosub "pr_2arr"
			add2 0.1,0
			arr2 = LayoutchangeHistory : gosub "pr_2arr"
		endif
	endif
else
	txt = "Добавьте Изм 0"
	gosub "write_error"
endif

!-------------- Сортировка массива с изменениями ---------------
if (type_sort_issue=1 or type_sort_issue=2) and n_err=0 then !По номеру изма.
	n_col = 1
	dim sort_arr[]
	for i=1 to n_izm
		var = change_info[i][n_col]
		if vartype(var)=2 then
			rez = SPLIT(var,"%n",var_num)
			var = var_num
		endif
		if vartype(var)=1 then
			sort_arr[i] = var
		else
			sort_arr[i] = 0
			txt = "Номер изменения должно быть числом -" + var
			gosub "write_error"
		endif
	next i
	for j=1 to n_izm
		flag_end=1
		for i=1 TO n_izm-j
			flag_swap = 0
			if type_sort_issue=1 then flag_swap = (sort_arr[i]<sort_arr[i+1])
			if type_sort_issue=2 then flag_swap = (sort_arr[i]>sort_arr[i+1])
			if flag_swap then
				kk = sort_arr[i]
				sort_arr[i] = sort_arr[i+1]
				sort_arr[i+1] = kk
				flag_end=0
			endif
		next i
		if flag_end then j=n_izm
	next j
	dim sort_arr_t[][]
	for j=1 to n_izm
		izm = sort_arr[j]
		for i=1 to n_izm
			var = change_info[i][n_col]
			if vartype(var)=2 then
				rez = SPLIT(var,"%n",var_num)
				var = var_num
			endif
			if vartype(var)=1 then
				if var = izm then
					for k=1 to vardim2(change_info)
						sort_arr_t[j][k] = change_info[i][k]
					next k
					i=n_izm
				endif
			endif
		next i
	next j
	change_info = sort_arr_t
endif
!-------------- Сортировка массива с изменениями ---------------

if n_izm_dop>0 then
	n_col = 1
	dim sort_arr[]
	for i=1 to n_izm_dop
		var = change_info_dop[i][n_col]
		if vartype(var)=2 then
			rez = SPLIT(var,"%n",var_num)
			var = var_num
			if strstr(change_info_dop[i][4], "AFD")>0 then var = var + 1
		endif
		if vartype(var)=1 then
			sort_arr[i] = var
		else
			sort_arr[i] = 0
		endif
	next i
	for j=1 to n_izm_dop
		flag_end=1
		for i=1 TO n_izm_dop-j
			flag_swap = (sort_arr[i]>sort_arr[i+1])
			if flag_swap then
				kk = sort_arr[i]
				sort_arr[i] = sort_arr[i+1]
				sort_arr[i+1] = kk
				flag_end=0
			endif
		next i
		if flag_end then j=n_izm_dop
	next j
	dim sort_arr_t[][]
	for j=1 to n_izm_dop
		izm = sort_arr[j]
		for i=1 to n_izm_dop
			var = change_info_dop[i][n_col]
			if vartype(var)=2 then
				rez = SPLIT(var,"%n",var_num)
				var = var_num
				if strstr(change_info_dop[i][4], "AFD")>0 then var = var + 1
			endif
			if vartype(var)=1 then
				if var = izm then
					for k=1 to vardim2(change_info_dop)
						sort_arr_t[j][k] = change_info_dop[i][k]
					next k
					i=n_izm_dop
				endif
			endif
		next i
	next j
	for j=1 to n_izm_dop
		if strlen(sort_arr_t[j][3])=0 then sort_arr_t[j][3] = current
	next j
	change_info_dop = sort_arr_t
	dim temp_arr[][]

	flag_new = 0 : flag_afd = 0
	if n_izm_dop>1 then
		if change_info_dop[n_izm_dop-1][2] = "Нов" then flag_new = 1
		if strstr(change_info_dop[n_izm_dop][4],"AFD")>0 then flag_afd = 1
	endif

	if change_info_dop[n_izm_dop][2] = "Нов" or (homeContext=5 and curren_ID > first_N_sheet) then
		temp_arr[1][1] = 0
		temp_arr[1][2] = "Нов"
		temp_arr[1][3] = change_info_dop[n_izm_dop][3]
		temp_arr[1][4] = change_info_dop[1][4]
		n_izm_dop = 1
		change_info_dop = temp_arr
	else
		if flag_new and flag_afd then
			temp_arr[1][1] = 0
			temp_arr[1][2] = "Нов"
			temp_arr[1][3] = change_info_dop[n_izm_dop-1][3]
			temp_arr[1][4] = change_info_dop[n_izm_dop-1][4]

			temp_arr[2][1] = 0
			temp_arr[2][2] = "Изм"
			temp_arr[2][3] = change_info_dop[n_izm_dop][3]
			temp_arr[2][4] = change_info_dop[n_izm_dop][4]
			n_izm_dop = 2
			change_info_dop = temp_arr
		endif
	endif

	end_date = 1
	redact = change_info_dop[n_izm_dop][1]
	if vartype(redact)=2 then
		redr = 0
		n = SPLIT (redact, "%n", redr)
		if n>0 and redr>0 then redact = redr
	endif
	if vartype(redact)=2 then redact = 0
	if n_izm>0 then
		for i=1 to n_izm
			if t_type<>"Нов" then
				n_izm_dop = n_izm_dop + 1
				if vartype(redact)=1 then redact = redact + 1
				change_info_dop[n_izm_dop][1] = redact
				change_info_dop[n_izm_dop][2] = t_type
				if i=n_izm then
					change_info_dop[n_izm_dop][3] = "23.01.23"
				else
					change_info_dop[n_izm_dop][3] = "10.11.22"
				endif
				change_info_dop[n_izm_dop][4] = "AFD - Approved for design / Утвержден для проектирования"
			else
				change_info_dop[n_izm_dop][3] = "23.01.23"
			endif
		next i
	else
		change_info_dop[n_izm_dop][3] = "23.01.23"
	endif
	tend_date = "23.01.23"
	tis_date = 1
	if vartype(redact)=1 then
		redact = "0" + str("%.0", redact)
	else
		redact = "0" + redact
	endif
	redact_date = change_info_dop[n_izm_dop][3]
	if hide_ifr then
		temp_arr[1][1] = 0
		temp_arr[1][2] = "Изм"
		temp_arr[1][3] = tend_date
		temp_arr[1][4] = change_info_dop[n_izm_dop][4]
		n_izm_dop = 1
		change_info_dop = temp_arr
	endif
endif

arr1 = error : gosub "pr_1arr"
if n_err > 0 then _bERROR = 1

gosub "read_rule"

L=0.01*GLOB_SCALE
MUL2   L,L

if not(is_autotext) then
	current_phase = phase
endif
if tend_date = " " then tend_date = current_date
tn_change = vardim1(change_info)
delim_part = pref + delim_part
shifr = " "
if shifrt_l<>" " and shifrt_l<>"" then
	if shifrt_l <>" " then shifr = shifrt_l + delim_part + current_part
else
	if shifrt <>" " then shifr = shifrt + delim_part + current_part
endif
if shifr<>" " then 
	shifr = shifr + suff
endif
if shifrt_l="-" then shifr = ""

ch1 = 1 : has_sign = 1
if tis_autosign then
	ch1 = OPEN ("TEXT", "Подпись", "SEPARATOR = ';', MODE = RO, LIBRARY")
	if ch1>0 then 
		has_sign = 1
	else
		print "Подпись не найдена"
		has_sign = 0
	endif
endif

IF type_table <> 99 and type_table > 4 THEN 
	HOTSPOT2 0,0
	is_end = 0
	IF type_table = 5 THEN
		gosub "table_type_5"
		is_end = 1
	endif
	IF type_table = 6 THEN !Дата изм 0
		SET STYLE "текст20-5"
		TEXT2  0,0,current_date 
		is_end = 1
	endif
	IF type_table = 7 THEN !Шифр
		SET STYLE "текст50-5"
		TEXT2  0,0,shifr 
		is_end = 1
	endif
	IF type_table = 8 THEN !Стадия
		SET STYLE "текст50-5"
		TEXT2  0,0,"Стадия " + current_phase 
		is_end = 1
	endif
	IF type_table = 9 THEN
		SET STYLE "текст50-5"
		if current_phase = "П" then naen_dok = "ПРОЕКТНАЯ ДОКУМЕНТАЦИЯ" 
		if current_phase = "Р" then naen_dok = "РАБОЧАЯ ДОКУМЕНТАЦИЯ" 
		TEXT2  0,0,naen_dok 
		is_end = 1
	endif

	IF type_table = 11 THEN END !Имя двг файла (устаревшее)
	if is_end then end
endif

gosub "fill_in"

if _bERROR then
	pen_small = pen_error
	pen_osn = pen_error
	pen_podp = pen_error
	pen_text = pen_error
	LINE2  0, 0, hsh, lsh
	LINE2  hsh, 0, 0, lsh
endif

IF is_boundary THEN gosub "out_boundary"
gosub "inner_boundary"

if type_table = 10 then
	is_second = 0
	if homeContext = 5 then
		curren_ID = 0
		n1= SPLIT (homeDBUserId, "%n", curren_ID)
		if curren_ID>1 then	is_second = 1
	endif
	if iscont then is_second = 1
	if not(is_second) then type_table = 1
endif

IF type_table = 99 THEN
	inx_1 = 0 : inx_2 = 0  : inx_3 = 0   : inx_4 = 0 : inx_n = 0 : inx_last = vardim1(change_info)
	for kk = 1 to vardim1(position_info)
		if strstr(position_info[kk][1], "контр", 1)>0 and strlen(position_info[kk][2])>5 and inx_n=0 then inx_n=kk
		if strstr(position_info[kk][1], table_99_izmvn, 1)>0 and strlen(table_99_izmvn)>1 and strlen(position_info[kk][2])>5 and inx_1=0 then inx_1=kk
		if strstr(position_info[kk][1], table_99_sost, 1)>0 and strlen(table_99_sost)>1 and strlen(position_info[kk][2])>5 and inx_2=0 then inx_2=kk
		if strstr(position_info[kk][1], table_99_gip, 1)>0 and strlen(table_99_gip)>1 and strlen(position_info[kk][2])>5 and inx_3=0 then inx_3=kk
		if strstr(position_info[kk][1], table_99_utv, 1)>0 and strlen(table_99_utv)>1 and strlen(position_info[kk][2])>5 and inx_4=0 then inx_4=kk
	next kk

	if table_99_izmvn = "Кто вносил изм" then inx_1 = -vardim1(change_info)
	if table_99_sost = "Кто вносил изм" then inx_2 = -vardim1(change_info)
	if table_99_gip = "Кто вносил изм" then inx_3 = -vardim1(change_info)
	if table_99_utv = "Кто вносил изм" then inx_4 = -vardim1(change_info)
	if abs(inx_n)> 0 then
		agreed_info[1][1] = "Н. контр."
		agreed_info[1][3] = current_date
		if inx_n>0 then
			agreed_info[1][2] = position_info[inx_n][2]
		else
			agreed_info[1][2] = change_info[abs(inx_n)][4]
		endif
	endif
	if vardim1(change_info)>0 then
		if table_99_info_1 = "№ изм" then
			str_info_1 = change_info[vardim1(change_info)][1]
		endif
		if table_99_info_1 = "№ док" then
			str_info_1 = change_info[vardim1(change_info)][3]
		endif
		if table_99_info_1 = "№ изм-год" then
			if strlen(change_info[vardim1(change_info)][5])>0 then
				year = change_info[vardim1(change_info)][5]
				pos = STRSTR (year, ".")-1
				year=STRSUB(year,pos+2,STRLEN(year))
				if STRSTR (year, ".")>0 then
					pos = STRSTR (year, ".")-1
					year=STRSUB(year,pos+2,STRLEN(year))
				endif
				if STRLEN(year)>2 then year=STRSUB(year,STRLEN(year)-1,STRLEN(year))
				str_info_1 = change_info[vardim1(change_info)][1] + "-" + year
			else
				str_info_1 = change_info[vardim1(change_info)][1]
			endif
		endif
	else
		str_info_1 = table_99_info_1
	endif
	if tis_RVI and type_table = 99 then
		for i=1 to vardim2(GlobIssueScheme)
			if STRSTR(GlobIssueScheme[1][i], "Somestuff_Izm_", 1)>0 and STRSTR(GlobIssueScheme[1][i], "_Column_", 1)>0 then
				inx_col_rvi = 0 : inx_row_rvi = 0
				for kk=1 to 100
					strf = "Somestuff_Izm_"+str("%.0", kk) + "_"
					if STRSTR(GlobIssueScheme[1][i], strf, 1)>0 then
						inx_row_rvi = kk
						kk=100
					endif
				next kk
				for kk=1 to 5
					strf = "Column_"+str("%.0", kk)
					if STRSTR(GlobIssueScheme[1][i], strf, 1)>0 then
						inx_col_rvi = kk
						kk=5
					endif
				next kk
				if inx_row_rvi>0 and inx_col_rvi>0 then
					rvi[inx_row_rvi][inx_col_rvi] = LayoutRevHistory[1][i]
				endif
			endif
		next i
	endif
endif

if is_dop_graph and type_table <> 10 then gosub "dop_graph"
if is_agreed and type_table <> 10 then gosub "agreed"


IF type_table = 98 THEN gosub "table_type_98"
IF type_table = 97 THEN gosub "table_type_9"
IF type_table = 99 THEN gosub "table_type_99"
IF type_table = 4 THEN gosub "table_type_4"
IF type_table = 3 THEN gosub "table_type_3"
IF type_table = 2 THEN gosub "table_type_2"
IF type_table = 1 THEN gosub "table_type_1"
IF type_table = 10 THEN gosub "table_type_10"
del top
END

"table_type_5": !"Регистрация изм (титул)"
	pen SYMB_VIEW_PEN
	lsh = 6
	hsh = max (2, tn_change*0.5+0.5)
	pen pen_osn
	RECT2 0, 0, lsh, hsh
	RECT2 0, hsh, lsh, hsh-0.5
	line2 1,0, 1, hsh
	line2 2.5,0, 2.5, hsh
	line2 4.5,0, 4.5, hsh
	hotspot2 1,0
	hotspot2 2.5,0
	hotspot2 4.5,0
	hotspot2 0,0
	hotspot2 lsh,0
	hotspot2 lsh,hsh
	hotspot2 0,hsh
	pen pen_small
	for x = 0.5 to hsh-1 step 0.5
		line2 0,x, lsh, x	
	next x
	PEN pen_text
	SET STYLE "текст18-5"
	text2 0.5,hsh-0.25,"Изм."
	text2 1.75,hsh-0.25,"№ док."
	text2 3.5,hsh-0.25,"Подп."
	text2 5.25,hsh-0.25,"Дата"
	i = 0
	for x = hsh-0.75 to 0 step -0.5
		i = i + 1
		if i <= tn_change then
			if vartype(change_info[i][2]) = 2 then 
				if strlen(change_info[i][2])>-1 then
					TEXT2  0.5, x, change_info[i][1]
					TEXT2  1.75, x, change_info[i][3]
					if end_date then change_info[i][5] = tend_date
					if tis_date then TEXT2  5.25, x, change_info[i][5]
					add2 2.6, x-0.25
					surname = change_info[i][4] : gosub "signature"
					del 1
				endif
			endif
		endif
	next x
return

"table_type_1":
	pen SYMB_VIEW_PEN
	ADD2 hsh-19, 0.5
	hotspot2 13.5, 1.5
	hotspot2 0, 0
	hotspot2 0, 5.5+(tn_change-4)*0.5*(tn_change>4)
	hotspot2 0, 5.5
	hotspot2 18.5,5.5
	hotspot2 1.7+0.3*gost_razm, 0
	hotspot2 1.7+0.3*gost_razm, 5.5+(tn_change-4)*0.5*(tn_change>4)
	hotspot2 4, 0
	hotspot2 4, 5.5+(tn_change-4)*0.5*(tn_change>4)
	hotspot2 5.5, 0
	hotspot2 5.5, 5.5+(tn_change-4)*0.5*(tn_change>4)
	hotspot2 6.5, 0
	hotspot2 6.5, 5.5+(tn_change-4)*0.5*(tn_change>4)
	hotspot2 6.5, 1.5
	hotspot2 18.5, 1.5
	hotspot2 13.5, 0
	hotspot2 13.5, 3.0
	hotspot2 15, 1.5
	hotspot2 15, 2.5
	hotspot2 15, 3.0
	hotspot2 16.5, 1.5
	hotspot2 16.5, 2.5
	hotspot2 16.5, 3.0
	hotspot2 13.5, 2.5
	hotspot2 18.5, 2.5
	hotspot2 6.5, 3.0
	hotspot2 18.5, 3.0
	hotspot2 6.5, 4.5
	hotspot2 18.5, 4.5

	pen pen_osn
	LINE2  0, 0, 0, 5.5+(tn_change-4)*0.5*(tn_change>4)
	LINE2  0, 5.5 ,18.5,5.5
	LINE2  1.7+0.3*gost_razm, 0, 1.7+0.3*gost_razm, 5.5+(tn_change-4)*0.5*(tn_change>4)
	LINE2  4, 0, 4, 5.5+(tn_change-4)*0.5*(tn_change>4)
	LINE2  5.5, 0, 5.5, 5.5+(tn_change-4)*0.5*(tn_change>4)
	LINE2  6.5, 0, 6.5, 5.5+(tn_change-4)*0.5*(tn_change>4)

	LINE2  0, 3.0, 18.5, 3.0
	LINE2  0, 3.5, 6.5, 3.5
	LINE2  6.5, 1.5, 18.5, 1.5
	LINE2  13.5, 0.0, 13.5, 3.0
	LINE2  15.0, 1.5, 15.0, 3.0
	LINE2  16.5, 1.5, 16.5, 3.0
	LINE2  13.5, 2.5, 18.5, 2.5
	LINE2  6.5, 4.5, 18.5, 4.5

	SET STYLE "текст20-5"
	PEN pen_text
	TEXT2  14.25, 2.75, "Стадия"
	TEXT2  15.75,2.75,"Лист"
	TEXT2  17.5,2.75,"Листов"
	SET STYLE "текст25-5"
	TEXT2  14.25, 2, current_phase
	TEXT2  15.75,2,sheet_id
	SET STYLE "текст50-5"
	if strlen(shifr)>1 then TEXT2  12.5,5,shifr
	SET STYLE "текст25-5"
	upper_bound = 5.5
	start_change = 3
	gosub "position"
RETURN

"table_type_2":
	pen SYMB_VIEW_PEN
	ADD2 hsh-19, 0.5
	hsh = 5.5
	if tn_change>4 then hsh = 5.5 + (tn_change-4)*0.5
	pen pen_osn
	LINE2  0, 0, 0, hsh
	LINE2  6.5, 5.5 ,18.5,5.5
	LINE2  1.7+0.3*gost_razm, 0, 1.7+0.3*gost_razm, hsh
	LINE2  4, 0, 4, hsh
	LINE2  5.5, 0, 5.5, hsh
	LINE2  6.5, 0, 6.5, hsh
	LINE2  6.5, 1.5, 18.5, 1.5
	LINE2  6.5, 4, 18.5, 4
	LINE2  13.5, 3.5, 18.5, 3.5
	LINE2  13.5, 2, 18.5, 2
	LINE2  13.5, 0, 13.5, 4
	LINE2  15, 2, 15, 4
	LINE2  16.5, 2, 16.5, 4
	LINE2  15.5, 1.5, 15.5, 2

	LINE2  0, 3, 6.5, 3
	LINE2  0, 3.5, 6.5, 3.5
	pen pen_small
	SET STYLE "текст20-5"
	PEN pen_text
	TEXT2  14.25, 3.75, "Стадия"
	TEXT2  15.75,3.75,"Масса"
	TEXT2  17.5,3.75,"Масштаб"
	TEXT2  14.0,1.75,"Лист"
	TEXT2  16.5,1.75,"Листов"
	SET STYLE "текст25-5"
	TEXT2  14.25, 2.75, current_phase
	TEXT2  15.75, 2.75, weight
!	TEXT2  17.5, 2.75, "б/м"
	SET STYLE "текст20-5"
	TEXT2  15,1.75,sheet_id
	SET STYLE "текст50-5"
	if strlen(shifr)>1 then TEXT2  12.5,4.75,shifr+delim_part+subpos
	SET STYLE "текст25-5"
	upper_bound = 5.5
	start_change = 3
	gosub "position"
RETURN

"table_type_3":
	pen SYMB_VIEW_PEN
	ADD2 hsh-19, 0.5
	pen pen_osn
	hsh = 4
	if tn_change>2 then hsh = 4 + (tn_change-2)*0.5
	LINE2  0, 0, 0, hsh
	LINE2  6.5, 4 ,18.5,4
	LINE2  1.7+0.3*gost_razm, 0, 1.7+0.3*gost_razm, hsh
	LINE2  4, 0, 4, hsh
	LINE2  5.5, 0, 5.5, hsh
	LINE2  6.5, 0, 6.5, hsh
	LINE2  15, 1.5, 15, 2.5
	LINE2  16.5, 1.5, 16.5, 2.5
	LINE2  13.5, 0, 13.5, 2.5
	LINE2  0, 2.5, 6.5, 2.5
	LINE2  0, 3, 6.5, 3
	LINE2  13.5, 1.5, 18.5, 1.5
	LINE2  0, 2.5, 18.5, 2.5
	LINE2  13.5, 2, 18.5, 2
	pen pen_small
	SET STYLE "текст20-5"
	PEN  pen_text
	TEXT2  14.25, 2.25, "Стадия"
	TEXT2  15.75,2.25,"Лист"
	TEXT2  17.5,2.25,"Листов"
	SET STYLE "текст20-5"
	TEXT2  14.25, 1.75, current_phase
	TEXT2  15.75,1.75,sheet_id
	SET STYLE "текст50-5"
	if strlen(shifr)>1 then TEXT2  12.5,3.2,shifr
	SET STYLE "текст25-5"
	TEXT2  10,1.25,naen_sheet
	add2 0, -0.5
	upper_bound = 4.5
	start_change = 3
	gosub "position"
	del 1
RETURN

"table_type_4":
	pen SYMB_VIEW_PEN
	ADD2 hsh-13.5, 0.5
	PEN pen_osn
	LINE2  0, 0, 0, 1.5
	LINE2  0, 1.5 ,13,1.5
	LINE2  12, 0, 12, 1.5
	LINE2  12, 1, 13, 1
	SET STYLE "текст20-5"
	PEN pen_text
	TEXT2  12.5,1.25,"Лист"
	TEXT2  12.5,0.5,sheet_id
	SET STYLE "текст50-5"
	if strlen(shifr)>1 then TEXT2  6.5,0.75,shifr
	SET STYLE "текст25-5"
RETURN

"table_type_99":
	pen SYMB_VIEW_PEN
	ADD2 hsh-19, 0.5
if table_99_gostrazm then
	PEN pen_small
	LINE2  0, 	0.5, 	6.5, 	0.5
	LINE2  0, 	1, 		6.5, 	1
	LINE2  0, 	1.5, 	6.5, 	1.5
	PEN pen_osn
	LINE2  16.5,	0.0,	16.5,	2.0
	LINE2  17.5,	0.0,	17.5,	2.0
	LINE2  0.0,		2.0,	18.5,	2.0
	LINE2  16.5,	1.0,	18.5,	1.0
	LINE2  1.5,		2.0,	1.5,	25.7
	LINE2  3.0,		2.0,	3.0,	28.7
	LINE2  13.0,	2.0,	13.0,	25.7
	LINE2  14.5,	2.0,	14.5,	25.7
	LINE2  0.0,		25.7,	18.5,	25.7
	LINE2  0.0,		24.2,	18.5,	24.2
	LINE2  0.0,		27.7,	18.5,	27.7
	LINE2  7,		25.7,	7,	28.7

	LINE2  0, 	0, 		0, 		2
	LINE2  1.7, 0, 		1.7, 	2
	LINE2  5.5, 0, 		5.5, 	2
	LINE2  6.5, 0, 		6.5, 	2
	LINE2  4, 	0, 		4, 		2

	SET STYLE "текст20-5"
	PEN  pen_text
	TEXT2  17.0,1.5,"Лист"
	TEXT2  18.0,1.5,"Лис-\nтов"
	TEXT2  0.75,24.95,"Изм."
	TEXT2  2.25,24.95,"Лист"
	TEXT2  8,24.95,"Содержание изменения"
	TEXT2  13.75,24.95,"Код"
	TEXT2  16.5,24.95,"Примечание"
	TEXT2  1.5,28.2,"Разрешение"
	TEXT2  5,28.2,"Обозначение"
	TEXT2  5,27.2,"Наименование"
	TEXT2  5,26.7,"объекта"
	TEXT2  5,26.2,"строительства"

	SET STYLE "текст20-5"
	TEXT2  17.0,0.5,sheet_id
	SET STYLE "текст50-5"
	if strlen(shifr)>1 then TEXT2  12.75,28.2,shifr
	TEXT2 1.5,26.7,str_info_1
else
	hotspot2 0.0,	0.0		! НЛ угол ШТАММПА А4
	hotspot2 0.0,	2.0		! ВЛ угол ШТАММПА А4
	hotspot2 0.0,	0.5
	hotspot2 0.0,	1.0
	hotspot2 0.0,	1.5
	hotspot2 1.7,	0.5
	hotspot2 1.7,	1.0
	hotspot2 1.7,	1.5
	hotspot2 4.0,	0.5
	hotspot2 4.0,	1.0
	hotspot2 4.0,	1.5
	hotspot2 5.5,	0.5
	hotspot2 5.5,	1.0
	hotspot2 5.5,	1.5
	hotspot2 6.5,	0.5
	hotspot2 6.5,	1.0
	hotspot2 6.5,	1.5
	hotspot2 18.5,	0.0		! НП угол ШТАММПА А4
	hotspot2 18.5,	2.0		! ВП угол ШТАММПА А4
	hotspot2 17.5,	0.0 
	hotspot2 17.5,	1.0 
	hotspot2 18.5,	1.0 
	hotspot2 17.5,	2.0
	hotspot2 16.5,	0.0 
	hotspot2 16.5,	1.0 
	hotspot2 16.5,	2.0
	hotspot2 5.5,	0.0
	hotspot2 5.5,	2.0
	hotspot2 1.7,	0.0
	hotspot2 1.7,	2.0
	hotspot2 4.0,	0.0
	hotspot2 4.0,	2.0
	hotspot2 6.5,	0.0
	hotspot2 6.5,	2.0

	hotspot2 1.5,	2.0
	hotspot2 3.0,	2.0
	hotspot2 13.5,	2.0
	hotspot2 15.0,	2.0
	hotspot2 1.5,	23.7
	hotspot2 3.0,	23.7
	hotspot2 13.5,	23.7
	hotspot2 15.0,	23.7
	hotspot2 0.0,	23.7
	hotspot2 18.5,	23.7
	hotspot2 1.5,	24.2
	hotspot2 3.0,	24.2
	hotspot2 13.5,	24.2
	hotspot2 15.0,	24.2
	hotspot2 0.0,	24.2
	hotspot2 18.5,	24.2
	hotspot2 7.5,	24.2
	hotspot2 7.5,	26.2
	hotspot2 3.0,	26.2
	hotspot2 0.0,	26.2
	hotspot2 18.5,	26.2
	hotspot2 7.5,	27.2
	hotspot2 3.0,	27.2
	hotspot2 0.0,	27.2
	hotspot2 18.5,	27.2
	hotspot2 4.0,	27.2
	hotspot2 4.0,	28.7

	PEN pen_small
	LINE2  0, 	0.5, 	6.5, 	0.5
	LINE2  0, 	1, 		6.5, 	1
	LINE2  0, 	1.5, 	6.5, 	1.5

	PEN pen_osn
	LINE2  16.5,	0.0,	16.5,	2.0
	LINE2  17.5,	0.0,	17.5,	2.0
	LINE2  0.0,		2.0,	18.5,	2.0
	LINE2  16.5,	1.0,	18.5,	1.0
	LINE2  1.5,		2.0,	1.5,	24.2
	LINE2  3.0,		2.0,	3.0,	27.2
	LINE2  13.5,	2.0,	13.5,	24.2
	LINE2  15.0,	2.0,	15.0,	24.2
	LINE2  0.0,		23.7,	18.5,	23.7
	LINE2  0.0,		24.2,	18.5,	24.2
	LINE2  0.0,		26.2,	18.5,	26.2
	LINE2  0.0,		27.2,	18.5,	27.2
	LINE2  4.0,		27.2,	4.0,	28.7
	LINE2  7.5,		24.2,	7.5,	27.2

	LINE2  0, 	0, 		0, 		2
	LINE2  1.7, 0, 		1.7, 	2
	LINE2  5.5, 0, 		5.5, 	2
	LINE2  6.5, 0, 		6.5, 	2
	LINE2  4, 	0, 		4, 		2

	SET STYLE "текст20-5"
	PEN  pen_text
	TEXT2  17.0,1.5,"Лист"
	TEXT2  18.0,1.5,"Лис-\nтов"
	TEXT2  0.8,23.9,"Изм."
	TEXT2  2.3,23.9,"Лист"
	TEXT2  8.5,23.9,"Содержание изменения"
	TEXT2  14.3,23.9,"Код"
	TEXT2  16.9,23.9,"Примечание"
	TEXT2  1.5,26.7,"Разрешение"
	TEXT2  5.3,26.7,"Обозначение"
	TEXT2  5.3,25.4,"Наименование объекта"
	TEXT2  5.3,25.0,"строительства"

	SET STYLE "текст20-5"
!	TEXT2  14.25, 1.75, current_phase
	TEXT2  17.0,0.5,sheet_id
	SET STYLE "текст50-5"
	TEXT2  11.5,27.9,"Разрешение на внесение изменений"
	if strlen(shifr)>1 then TEXT2  13.0,26.6,shifr
	TEXT2 1.5,25.2,str_info_1
	SET STYLE "текст25-5"
endif
	SET STYLE "текст20-4"
	PEN  pen_text
	TEXT2  0.1,1.7,"Изм. внес"
	TEXT2  0.1,1.2,"Составил"
	TEXT2  0.1,0.7,"ГИП"
	TEXT2  0.1,0.2,"Утв."

	if tis_RVI and vardim1(rvi)>0 then
		rrr = request("Height_of_style","текст20-4", txt_hgt)
		txt_hgt = txt_hgt * 0.1
		sx = 23.7 : if table_99_gostrazm then sx = 24.2
		hr = 0.8
		for i=1 to vardim1(rvi)
			if strlen(rvi[i][3])>0 then
				sx = sx - txt_hgt
				hr_ = hr
				SET STYLE "текст20-5"
				txt_2 = rvi[i][2] : mlb_in_str = rvi[i][2] : mlb_l_max = 14
				if stw(mlb_in_str)>=mlb_l_max then
					mlb_n_row = 1 : mlb_out_str = "!"
					call "macro_line_break" parameters mlb_in_str=mlb_in_str, mlb_l_max=mlb_l_max,mlb_in_scale=1, RETURNED_PARAMETERS mlb_n_row, mlb_out_str, mlb_out_str_arr
					hr_ = max(hr_, mlb_n_row*txt_hgt)
					txt_2 = mlb_out_str
				endif
				txt_3 = rvi[i][3] : mlb_in_str = rvi[i][3] : mlb_l_max = 99
				if stw(mlb_in_str)>=mlb_l_max then
					mlb_n_row = 1 : mlb_out_str = "!"
					call "macro_line_break" parameters mlb_in_str=mlb_in_str, mlb_l_max=mlb_l_max,mlb_in_scale=1, RETURNED_PARAMETERS mlb_n_row, mlb_out_str, mlb_out_str_arr
					hr_ = max(hr_, mlb_n_row*txt_hgt)
					txt_3 = mlb_out_str
					SET STYLE "текст20-1"
					text2 3.2,sx,txt_3
				else
					SET STYLE "текст20-4"
					text2 3.2,sx-hr_/2,txt_3
				endif
				SET STYLE "текст20-5"
				text2 2.25,sx-hr_/2,txt_2
				text2 0.75,sx-hr_/2,rvi[i][1]
				text2 13.75,sx-hr_/2,rvi[i][4]
				sx = sx - hr_
				line2 0, sx - txt_hgt/2, 18.5, sx - txt_hgt/2
			endif
		next i
	endif

	if not(_bfirstchange) and tis_position then
		inx_ = inx_4 : x = 0.2
		if abs(inx_)>0 then
			if inx_>0 then
				_str = position_info[inx_][2]
			else
				_str = change_info[abs(inx_)][4]
			endif
			SET STYLE "текст18-4"
			if tis_fam then TEXT2  1.8, x, _str
			add2 4.1, x-0.25
			surname = _str : gosub "signature"
			del 1
			SET STYLE "текст18-5"
			if tis_date then TEXT2  6, x, tend_date
		endif

		inx_ = inx_3 : x = 0.7
		if abs(inx_)>0 then
			if inx_>0 then
				_str = position_info[inx_][2]
			else
				_str = change_info[abs(inx_)][4]
			endif
			SET STYLE "текст18-4"
			if tis_fam then TEXT2  1.8, x, _str
			add2 4.1, x-0.25
			surname = _str : gosub "signature"
			del 1
			SET STYLE "текст18-5"
			if tis_date then TEXT2  6, x, tend_date
		endif

		inx_ = inx_2 : x = 1.2
		if abs(inx_)>0 then
			if inx_>0 then
				_str = position_info[inx_][2]
			else
				_str = change_info[abs(inx_)][4]
			endif
			SET STYLE "текст18-4"
			if tis_fam then TEXT2  1.8, x, _str
			add2 4.1, x-0.25
			surname = _str : gosub "signature"
			del 1
			SET STYLE "текст18-5"
			if tis_date then TEXT2  6, x, tend_date
		endif
		inx_ = inx_1 : x = 1.7
		if abs(inx_)>0 then
			if inx_>0 then
				_str = position_info[inx_][2]
			else
				_str = change_info[abs(inx_)][4]
			endif
			SET STYLE "текст18-4"
			if tis_fam then TEXT2  1.8, x, _str
			add2 4.1, x-0.25
			surname = _str : gosub "signature"
			del 1
			SET STYLE "текст18-5"
			if tis_date then TEXT2  6, x, tend_date
		endif
	endif
RETURN


"table_type_9":
	ADD2 hsh-19.0, 0.5
	hsh = 1.5
	if tn_change>2 then hsh = 1.5 + (tn_change-2)*0.5
	pen pen_small
	for jj=1 to hsh-0.5 step 0.5
		LINE2  0.0, jj, 6.5, jj
	next jj
	LINE2  17.5, 1, 18.5, 1
	PEN pen_osn
	LINE2  0, 0, 0, hsh
	LINE2  6.5, 1.5 ,18.5,1.5
	LINE2  17.5, 0, 17.5, 1.5
	LINE2  0.85+0.15*gost_razm, 0, 0.85+0.15*gost_razm, hsh
	LINE2  1.7+0.3*gost_razm, 0, 1.7+0.3*gost_razm, hsh
	LINE2  2.85+0.15*gost_razm, 0, 2.85+0.15*gost_razm, hsh
	LINE2  4.0, 0, 4.0, hsh
	LINE2  5.5, 0, 5.5, hsh
	LINE2  6.5, 0, 6.5, hsh
	LINE2  0, hsh, 6.5, hsh
	LINE2  0.0, 0.5, 6.5, 0.5

	SET STYLE "текст20-5"
	PEN pen_text
	TEXT2  18,1.25,"Лист"
	SET STYLE "текст25-5"
	TEXT2  18,0.5,sheet_id
	IF is_position = 1 THEN
		if tis_position and not(_bERROR) and diff_type_tabe=0 then 
			if prim_arh then
				if vartype(position_info[1][2]) = 2 then
					IF strlen(position_info[1][2])>2 THEN TEXT2 12,1.1,"<NOTES>" + ". Арх. " + position_info[1][2] + ". <SUBSETID>"
				endif	
			else
				SET STYLE "текст50-5"
				if strlen(shifr)>1 then TEXT2 12.1,0.7,shifr
			endif
		endif	
	ENDIF
	SET STYLE "текст18-5"
	TEXT2  0.45+0.05*gost_razm, 0.25, "Изм."
	TEXT2  1.30+0.2*gost_razm, 0.25, "Кол.уч."
	TEXT2  2.3+0.2*gost_razm, 0.25, "Лист"
	TEXT2  3.4+0.1*gost_razm, 0.25, "№ док."
	TEXT2  4.8-0.05*gost_razm, 0.25, "Подп."
	TEXT2  6.0, 0.25, "Дата"
	FOR y = 0 TO 1.5 STEP 0.5
		HOTSPOT2 0.0, y
		HOTSPOT2 0.85+0.15*gost_razm, y
		HOTSPOT2 1.7+0.3*gost_razm, y
		HOTSPOT2 2.85+0.15*gost_razm, y
		HOTSPOT2 4.0, y
		HOTSPOT2 5.5, y
		HOTSPOT2 6.5, y
	NEXT y
	HOTSPOT2 18.5, 1
	HOTSPOT2 18.5, 1.5
	HOTSPOT2 17.5, 0
	HOTSPOT2 17.5, 1
	HOTSPOT2 17.5, 1.5
	if not(_bfirstchange) and tis_position then
		SET STYLE "текст18-5"
		i = 0
		for x = 0.75 to hsh step 0.5
			i = i + 1
			if i <= tn_change then
				if vartype(change_info[i][2]) = 2 then 
					if strlen(change_info[i][2])>-1 then
						TEXT2  0.45+0.05*gost_razm, x, change_info[i][1]
						TEXT2  1.3+0.2*gost_razm, x, change_info[i][6]
						TEXT2  2.3+0.2*gost_razm, x, change_info[i][2]
						TEXT2  3.4+0.1*gost_razm, x, change_info[i][3]
						add2 4.1-0.05*gost_razm, x-0.25
						surname = change_info[i][4] : gosub "signature"
						del 1
						if tis_date then TEXT2  6.0, x, change_info[i][5]
					endif
				endif
			endif
		next x
	endif
RETURN

"table_type_98":
	HOTSPOT2 0 , 0
	HOTSPOT2 hsh, lsh
	HOTSPOT2 hsh, 0
	HOTSPOT2 0, lsh
if tis_position and not(_bERROR) then 
	! Подписи
	if vardim1(change_info) > 0 THEN
		SET STYLE "текст20-5"
		TEXT2 2.8,18.2, change_info[vardim1(change_info)][3]
		TEXT2 4.2,18.45, "Изм.    ."
		TEXT2 4.55,18.45, change_info[vardim1(change_info)][1]
		ADD2	6, 7.8
		surname = change_info[vardim1(change_info)][4] : gosub "signature"
		ADD2	0.3, -1.1
		surname = change_info[vardim1(change_info)][4] : gosub "signature"
	ELSE
		SET STYLE "текст20-5"
		TEXT2 2.8,18.2, "1"
		ADD2	6, 7.8
		surname = position_info[1][2] : gosub "signature"
		ADD2	0.3, -1.1
		surname = position_info[1][2] : gosub "signature"		
	ENDIF
	ADD2	0.5, -1.0
	surname = position_info[6][2] : gosub "signature"
endif

RETURN

"table_type_10":
	pen SYMB_VIEW_PEN
	ADD2 hsh-19, 0.5
	hotspot2 13.5, 1.5
	hotspot2 0, 0
	hotspot2 0, 1.5+(tn_change-2)*0.5*(tn_change>2)
	hotspot2 0, 1.5
	hotspot2 18.5,1.5
	hotspot2 1.7, 0
	hotspot2 1.7, 1.5+(tn_change-2)*0.5*(tn_change>2)
	hotspot2 4, 0
	hotspot2 4, 1.5+(tn_change-2)*0.5*(tn_change>2)
	hotspot2 5.5, 0
	hotspot2 5.5, 1.5+(tn_change-2)*0.5*(tn_change>2)
	hotspot2 6.5, 0
	hotspot2 6.5, 1.5+(tn_change-2)*0.5*(tn_change>2)
	hotspot2 6.5, 1.5
	hotspot2 18.5, 1.5

	pen pen_osn
	LINE2  0, 0, 0, 1.5+(tn_change-2)*0.5*(tn_change>2)
	LINE2  6.5, 1.5 ,18.5,1.5
	LINE2  1.7, 0, 1.7, 1.5+(tn_change-2)*0.5*(tn_change>2)
	LINE2  4, 0, 4, 1.5+(tn_change-2)*0.5*(tn_change>2)
	LINE2  5.5, 0, 5.5, 1.5+(tn_change-2)*0.5*(tn_change>2)
	LINE2  6.5, 0, 6.5, 1.5+(tn_change-2)*0.5*(tn_change>2)
	LINE2  17.5, 0 ,17.5,1.5
	LINE2  17.5, 1 ,18.5,1

	SET STYLE "текст20-5"
	PEN pen_text
	TEXT2  18,1.25,"Лист"
	SET STYLE "текст25-5"
	TEXT2  18,0.5,sheet_id
	SET STYLE "текст50-5"
	if strlen(shifr)>1 then TEXT2  12,0.75,shifr
	SET STYLE "текст25-5"
	upper_bound = 1.5
	start_change = 0
	gosub "position"
RETURN

"dop_graph":
	pen pen_osn
	LINE2  0.8, 0.5, 0.8, 9
	LINE2  1.3, 0.5, 1.3, 9
	LINE2  0.8, 0.5, 2, .5
	LINE2  0.8, 3, 2, 3
	LINE2  0.8, 6.5, 2, 6.5
	LINE2  0.8, 9, 2, 9
	SET STYLE "текст20-5"
	PEN pen_text
	if strstr(rule_name, "СНХП")>0 then
		DEFINE STYLE "текст20-5m"  fontType, 0.25, 4, r205type
		SET STYLE "текст20-5m"
		TEXTBLOCK "1" 0, 1, 90, 0.7, 0.99, 0, "Инв. № подл. \Inv. No. Orig."
		RICHTEXT2 0.92, 0.59, "1"
		TEXTBLOCK "2" 0, 1, 90, 1, 0.99, 0, "Подп. и дата\Sign & Date"
		RICHTEXT2 0.92, 3.1, "2"
		TEXTBLOCK "3" 0, 1, 90, 0.7, 0.99, 0, "Взам. инв. №\Sup. Inv. No."
		RICHTEXT2 0.92, 6.6, "3"
		ADD2 1.05, 1.5
		ROT2 90
		SET STYLE "текст20-4"
		TEXT2  -0.5, -0.6, inv_no
		if tis_date then TEXT2  3, -0.6, inv_date
		SET STYLE "текст20-5"
		del 2
	else
		ADD2 1.05, 1.5
		ROT2 90
		TEXT2  0, 0, " Инв. N подл."
		TEXT2  3,0," Подпись и дата"
		TEXT2  6,0,"   Взамен инв. N"
		DEL  2
	endif
return

"agreed":
	rot2 90
	if is_dop_graph then add2 8.5,0
	add2 0.5,-2
	ngragr=1
	if tis_position and not(_bERROR) then ngragr =  max(1,round_int((vardim1(agreed_info)-2)/3)+2)
	if tis_position and not(_bERROR) and vardim1(agreed_info)<3 then ngragr = 1
	pen pen_small
	line2 0,0.5,ngragr*6.5,0.5
	line2 6.5,1,ngragr*6.5,1
	pen pen_osn
	line2 6.5,1,0,1
	line2 0,1.5,ngragr*6.5,1.5
	line2 0,0,ngragr*6.5,0
	line2 0,0,0,1.5
	line2 2,0,2,1
	line2 4,0,4,1
	line2 5.5,0,5.5,1
	line2 6.5,0,6.5,1.5
	if ngragr>1 then
		for i=1 to ngragr-1
			line2 2+i*6.5,0,2+i*6.5,1.5
			line2 4+i*6.5,0,4+i*6.5,1.5
			line2 5.5+i*6.5,0,5.5+i*6.5,1.5
			line2 6.5+i*6.5,0,6.5+i*6.5,1.5
		next i
	endif
	SET STYLE "текст20-4"
	PEN pen_text
	if strstr(rule_name, "СНХП")>0 then
		text2 0.05,1.20,"Согласовано / Approved"
	else
		text2 0.05,1.20,"Согласовано"
	endif
	if tis_position and not(_bERROR) then
	nfam = 0
	x = 0.75
	y = 0
	for i=1 to vardim1(agreed_info)
		if i=2 then nfam = 3
		if nfam>3 then
			nfam = 1
			y = y + 6.5
			x = 1.25
		endif
		if vartype(agreed_info[i][2]) = 2 then 
			if strlen(agreed_info[i][2])>2 then
				SET STYLE "текст18-4"
				PEN pen_text
				TEXT2  0.05+y, x, agreed_info[i][1]
				if tis_fam then TEXT2  2.05+y, x, agreed_info[i][2]
				if end_date then agreed_info[i][3] = tend_date
				if tis_date then TEXT2  5.55+y, x, agreed_info[i][3]
				add2 4.0+y, x-0.25
				surname = agreed_info[i][2] : gosub "signature"
				del 1
			endif
		endif
		nfam = nfam + 1
		x = x - 0.5
	next i
	endif
	del 2
	if is_dop_graph then del 1
return

"out_boundary":
	RECT2 0, 0, hsh, lsh
	HOTSPOT2 0 , 0
	HOTSPOT2 hsh, lsh
	HOTSPOT2 hsh, 0
	HOTSPOT2 0, lsh
	hotline2 0 , 0, hsh, 0
	hotline2 hsh, 0, hsh, lsh
	hotline2 hsh, lsh, 0, lsh
	hotline2 0, lsh, 0, 0
return

"inner_boundary":
	pen pen_osn
	RECT2 2 , 0.5, hsh-.5, lsh-.5
	HOTSPOT2 2 , lsh-.5
	HOTSPOT2 hsh-.5, lsh-.5
	HOTSPOT2 2 , 0.5
	HOTSPOT2 hsh-.5, 0.5
	HOTline2 2 , lsh-.5, hsh-.5, lsh-.5
	HOTline2 hsh-.5, lsh-.5,hsh-.5 , 0.5
	HOTline2 2 , 0.5,hsh-.5, 0.5
	HOTline2 2 , 0.5,2 , lsh-.5
	PEN pen_text
	SET STYLE "текст18-1"
	if strstr(rule_name, "СНХП")>0 then
		format_ = "Формат / Size " 
		TEXT2  hsh-19,0.37,shifr + "-" + redact + "-RU.dwg"
	else
		format_ = "Формат " 
	endif
	if format<>"ПРОИЗВОЛЬНЫЙ" then
		TEXT2  hsh-4.8, .37, format_ + format
	else
		TEXT2  hsh-4.8, .37, format_ + name_custom
	endif
	if show_date then
		SET STYLE "date"
		PEN pen_text
		current_out = ""
		ch = OPEN ("DateTime", "", "%Y-%m-%d-%H-%M-%S")
		n = INPUT (ch, "", "", current_out)
		rot2 90
		text2 0.51,-1.98,current_out
		del 1
		CLOSE (ch)
		pen pen_osn
	endif
return

"position":
	IF type_table < 4 or type_table = 10 then
		HOTSPOT2 0, upper_bound+(tn_change-4)*0.5*(tn_change>4)
		HOTSPOT2 18.5, upper_bound+(tn_change-4)*0.5*(tn_change>4)
		HOTSPOT2 0, 0
		HOTSPOT2 18.5, 0
		hotspot2 0.85+0.15*gost_razm, start_change
		hotspot2 0.85+0.15*gost_razm, upper_bound+(tn_change-4)*0.5*(tn_change>4)
		hotspot2 2.85+0.15*gost_razm, start_change
		hotspot2 2.85+0.15*gost_razm, upper_bound+(tn_change-4)*0.5*(tn_change>4)
		pen pen_small

		_hsh = 18.5
		_lsh = upper_bound+(tn_change-4)*0.5*(tn_change>4)
		
		if type_table < 3 then
			max_change = 3
			max_change_2 = 4
		else
			max_change = 2
			max_change_2 = 2
		endif
		for x = 0.5 to upper_bound+(tn_change-max_change)*0.5*(tn_change>=max_change) - 0.5 step 0.5
			LINE2  0, x, 6.5, x
			hotspot2 0, x
			hotspot2 6.5, x
		next x
		pen pen_osn
		LINE2  6.5, upper_bound+(tn_change-max_change_2)*0.5*(tn_change>max_change_2), 0, upper_bound+(tn_change-max_change_2)*0.5*(tn_change>max_change_2)
		LINE2  0.85+0.15*gost_razm, start_change, 0.85+0.15*gost_razm, upper_bound+(tn_change-max_change_2)*0.5*(tn_change>max_change_2)
		LINE2  2.85+0.15*gost_razm, start_change, 2.85+0.15*gost_razm, upper_bound+(tn_change-max_change_2)*0.5*(tn_change>max_change_2)
		PEN pen_text
		SET STYLE "текст18-5"
		TEXT2  0.45+0.05*gost_razm, start_change + 0.25, "Изм."
		TEXT2  1.30+0.2*gost_razm, start_change + 0.25, "Кол.уч."
		TEXT2  2.3+0.2*gost_razm, start_change + 0.25, "Лист"
		TEXT2  3.4+0.1*gost_razm, start_change + 0.25, "№ док."
		TEXT2  4.8-0.05*gost_razm, start_change + 0.25, "Подп."
		TEXT2  6.0, start_change + 0.25, "Дата"
		if _bERROR then
			LINE2  0, 0, 18.5, upper_bound
			LINE2 18.5, 0, 0, upper_bound
		endif
		if not(_bfirstchange) and tis_position then
			SET STYLE "текст18-5"
			i = 0
			for x = start_change + 0.75 to upper_bound+(tn_change-max_change_2)*0.5*(tn_change>max_change_2) step 0.5
				i = i + 1
				if i <= tn_change then
					if vartype(change_info[i][2]) = 2 then 
						if strlen(change_info[i][2])>-1 then
							TEXT2  0.45+0.05*gost_razm, x, change_info[i][1]
							TEXT2  1.3+0.2*gost_razm, x, change_info[i][6]
							TEXT2  2.3+0.2*gost_razm, x, change_info[i][2]
							TEXT2  3.4+0.1*gost_razm, x, change_info[i][3]
							add2 4.1-0.05*gost_razm, x-0.25
							surname = change_info[i][4] : gosub "signature"
							del 1
							if tis_date then TEXT2  6.0, x, change_info[i][5]
						endif
					endif
				endif
			next x
		endif
	endif
	if tis_position and not(_bERROR) and type_table <> 10 then 
		SET STYLE "текст18-4"
		i = 0
		for x = 2.75 to 0.25 step -0.5
			i = i + 1
			if i <= vardim1(position_info) then
				if vartype(position_info[i][2]) = 2 then 
					if strlen(position_info[i][2])>2 then
						PEN pen_text
						TEXT2  0.1, x, position_info[i][1]
						if tis_fam then TEXT2  1.8+0.3*gost_razm, x, position_info[i][2]
						SET STYLE "текст18-5"
						if end_date then position_info[i][3] = tend_date
						if tis_date then
							if strlen(position_info[i][3])>5 then
								SET STYLE "текст18-5-2"
								TEXTBLOCK str("%.0",i) 0, 5, 0, 0.95, 0.95, 1, position_info[i][3]

								sss=request("Height_of_style", "текст18-5-2", height, descent, leading)
								dx = (height/2-descent-leading-r184/2)
								n = REQUEST("TEXTBLOCK_INFO", tblockname, width, height)
								RICHTEXT2 6, x-r184/30, str("%.0",i)

							else
								TEXT2  6, x, position_info[i][3]
							endif
						endif
						SET STYLE "текст18-4"
						add2 4.0+0.2*gost_razm, x-0.3
						surname = position_info[i][2] : gosub "signature"
						del 1
					endif
				endif
			endif
		next x
	endif
	gosub "dop_table_rule"
return

"signature":
	if tis_autosign and has_sign and is_autosign then
		DRAWINDEX 50
		PEN pen_podp
		CALL "Подпись" parameters surname = surname, pen_podp=pen_podp
		PEN pen_text
		DRAWINDEX 10
	endif
return


"fill_in":
	dx = 0
	if fill_ramka then
		DRAWINDEX 10
		put 0,0,1
		put hsh,0,1
		put hsh,lsh,1
		put 0,lsh,1
		put 0,0,-1
	
		put 2+dx, 0.5+dx,1
		put hsh-.5-dx , 0.5+dx,1
		put hsh-.5-dx, lsh-.5-dx,1
		put 2+dx, lsh-.5-dx,1
		put 2+dx , 0.5+dx,-1
		fill GLOB_FILL_INDEX_SOLID
		pen 19
		POLY2_ NSP/3, 1+2+4, get(NSP)
		DRAWINDEX 20
	endif
return

"pr_2arr":
	k=0
	for i = 1 to vardim1(arr2)
		for j = 1 to vardim2(arr2)
			text2 0,-0.01*k,arr2[i][j]
			text2 -0.01,-0.01*k,i
			text2 -0.02,-0.01*k,j
			k = k+1
		next j
	next i
return
"pr_1arr":
	k=0
	for i = 1 to vardim1(arr1)
			text2 0,-0.01*k,arr1[i]
			text2 -0.01,-0.01*k,i
			k = k+1
	next i
return

"write_error":
	n_err = n_err + 1
	error[n_err] = txt
return

"from_layout":
	for i = ROW_FAM_START_LAYUOT to ROW_FAM_END_LAYUOT
		if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then
			flag = 1
			for j = 1 to n_position
				if GlobIssueScheme[1][i]= position_info[j][1] then flag = 0
			next j
			if flag then
				n_position = n_position + 1
				position_info[n_position][1] = GlobIssueScheme[1][i]
				position_info[n_position][2] = LayoutRevHistory[last_rev_inx][i]
				position_info[n_position][3] = current_date
			endif
		endif
	next i
return

"from_issue":
	for i = ROW_FAM_START_ISSUE to ROW_FAM_END_ISSUE
		if STRLEN(LayoutRevHistory[last_rev_inx][i])>1 then
			flag = 1
			for j = 1 to n_position
				if GlobIssueScheme[1][i]= position_info[j][1] then flag = 0
			next j
			if flag then
				n_position = n_position + 1
				position_info[n_position][1] = GlobIssueScheme[1][i]
				position_info[n_position][2] = LayoutRevHistory[last_rev_inx][i]
				position_info[n_position][3] = current_date
			endif
		endif
	next i
return

"from_change":
	for i = ROW_FAM_START_CHANGE to ROW_FAM_END_CHANGE
		if STRLEN(LayoutchangeHistory[zero_change_inx][i])>1 then
			flag = 1
			for j = 1 to n_position
				if GlobchangeScheme[1][i]= position_info[j][1] then flag = 0
			next j
			if flag then
				n_position = n_position + 1
				position_info[n_position][1] = GlobchangeScheme[1][i]
				position_info[n_position][2] = LayoutchangeHistory[zero_change_inx][i]
				position_info[n_position][3] = current_date
			endif
		endif
	next i
return

"read_rule":
	redact_rule = ""
	redact_name_rule = ""
	redact_date_rule = ""
	tend_date_rule = ""
	inv_date_rule = ""
	read_rule = 0
	if rule_name = "Нет" then rule_name = ""
	if strlen(rule_name)>0 and rule_name<>" " then

		if strstr(rule_name, "СНХП")>0 then
			redact_date_rule = "current"
			redact_rule = "00"
			redact_name_rule = "IFR - Issued for review / Выпущено для рассмотрения"
			read_rule = 1
		endif
	endif
return

!!!============================= Доп. таблицы штампов дляразличных правил заказчика ==================
"dop_table_rule":
	if read_rule = 1 then
		if strstr(rule_name, "СНХП")>0 then
			set style "текст25-5"
			add2 0,_lsh
			iy = 4.21
			tis_autosign_ = tis_autosign
			n_start = max(1, n_izm_dop-2)
			for ik=n_start to n_izm_dop
				redact_n = change_info_dop[ik][1]
				if vartype(redact_n)=2 then
					if strlen(redact_n)=0 then redact_n = "0"
					redact_n = "0" + redact_n
				else
					redact_n = "0" + str("%.0", redact_n)
				endif
				text2 0.55,iy,redact_n
				text2 2.05,iy,change_info_dop[ik][3]
				text2 7.75,iy,change_info_dop[ik][4]
				add2 11, iy-0.25
				if strstr(change_info_dop[ik][4],"AFD")=1 and tis_autosign_=1 and ik=n_izm_dop then
					for ii=1 to 3
						flag_find_ = 0
						for kk = 1 to vardim1(position_info)
							if strstr(position_info[kk][1], "азраб")>0 and ii = 1 then flag_find_ = 1
							if strstr(position_info[kk][1], "ров")>0 and ii = 2 then flag_find_ = 1
							if strstr(position_info[kk][1], "ГИП")>0 and ii = 3 then flag_find_ = 1
							if strlen(position_info[kk][2])<3 and flag_find_ = 1 then flag_find_ = 0
							if flag_find_ = 1 then
								add2 2,0
								surname = position_info[kk][2] : gosub "signature"
								kk = vardim1(position_info) 
							endif
						next kk
						if ii = 2 and flag_find_ = 0 then
							for kk = 1 to vardim1(position_info)
								if strstr(position_info[kk][1], "контр")>0 then flag_find_ = 1
								if flag_find_ = 1 then
									add2 2,0
									surname = position_info[kk][2] : gosub "signature"
									kk = vardim1(position_info) 
								endif
							next kk
						endif
					next ii
					del 3
				endif
				del 1
				add2 0,0.5
			next ik
		endif
	endif
	tis_autosign = tis_autosign_
return
!!!========================================= Конец доптаблиц =========================================
