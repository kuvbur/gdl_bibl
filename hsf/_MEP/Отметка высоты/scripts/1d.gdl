bOpaque = AC_bLabelOpaqueFillpenOpaque=AC_LabelTextBgrPenpenLine = AC_LabelPointerPenpenFont = AC_TextPen_1nameFont = AC_TextFont_1AC_TextSize_1 = AC_TextSize_1iscall = 1PARAMETERS penArrow = LABEL_ARROWHEAD_PENcall_y = 0nd1 = request("Assoclp_parvalue", "otm_elem", namindd1, typed1, flagd1, dim1d1, dim2d1, call_y)if isabs then	call_y = 0	nd1 = request("Assoclp_parvalue", "otm_elem_abs", namindd1, typed1, flagd1, dim1d1, dim2d1, call_y)endif! Document name:!   Name     : Отметка высоты (ГОСТ) / Elevation Dimension (GOST)!   Version  : 10.0!   Author   : Вилисов В.Ю. (Valery W)!   Date     : 20 June 2006!   Modified : 18 September 2006!   Modified : 10 February 2007!! ======================================================EPS=0.0001! ======================================================! Определение единицы измерения! ======================================================	wlu = ""	rrr = REQUEST ("Working_length_unit", "", wlu) 	! Запрос системы измерения	unit = ""	IF STRSTR (wlu, "m")  THEN unit = "м"	IF STRSTR (wlu, "cm") THEN unit = "см"	IF STRSTR (wlu, "mm") THEN unit = "мм"	IF STRSTR (wlu, "df") THEN unit = "df"	IF STRSTR (wlu, "fi") THEN unit = "fi"	IF STRSTR (wlu, "di") THEN unit = "di"	ElevDimUnit = ""	if GLOB_SCRIPT_TYPE = 2 then rr = REQUEST ("Elevation_dimension", "", ElevDimUnit) 	! Запрос размерной единицы высоты	! ======================================================! Преобразование текста в значения! ======================================================	IF txtRoundValue = "0,001"	 THEN	RoundValue = 0.001	IF txtRoundValue = "0,005"	 THEN	RoundValue = 0.005	IF txtRoundValue = "0,010"	 THEN	RoundValue = 0.010	IF txtRoundValue = "0,025"	 THEN	RoundValue = 0.025	IF txtRoundValue = "0,050"	 THEN	RoundValue = 0.050		IF txtArrowType = "Стандарт" THEN	iArrowType = 1	IF txtArrowType = "Эскиз 1"	 THEN	iArrowType = 2	IF txtArrowType = "Эскиз 2"	 THEN	iArrowType = 3	IF txtArrowType = "Эскиз 3"	 THEN	iArrowType = 4	IF txtArrowType = "Эскиз 4"	 THEN	iArrowType = 5	IF txtArrowType = "Эскиз 5"	 THEN	iArrowType = 6	! ======================================================! Запрос списка шрифтов в системе! ======================================================	DIM fontNames[]	n = request("FONTNAMES_LIST", "", fontNames)	! ======================================================! Установка стилей! ======================================================	DEFINE STYLE{2} "normalText" nameFont, AC_TextSize_1,	 AC_TextStyle_1	DEFINE STYLE{2} "superText"  nameFont, AC_TextSize_1,	 AC_TextStyle_1+32	DEFINE STYLE{2} "smallText"  nameFont, AC_TextSize_1*3/4, AC_TextStyle_1! ======================================================! Установка Размерного текста! ======================================================!<----- Получение поправки для привязки к уровню -----------mrh_ref_story = ref_storydim mrh_ref_story_text[7] : mrh_ref_story_text[1] = ""dim mrh_ref_story_val[7] : mrh_ref_story_val[1] = 0mrh_reference_heigh = 0call "macro_reference_height" parameters mrh_ref_story = mrh_ref_story,								RETURNED_PARAMETERS mrh_reference_heigh, mrh_ref_story_text, mrh_ref_story_val!>----- Получение поправки для привязки к уровню -----------if ref_story>0 then DimOrigin = mrh_reference_heighDimOrigin = DimOrigin + poprsymb = SYMB_POS_Zif pl=0 then symb=SYMB_POS_Yif iscall then symb=call_yDimY = INT((symb - DimOrigin + RoundValue/2) /RoundValue) *RoundValueDimf = INT((symb - DimOrigin + RoundValue/2) /RoundValue) *RoundValueTextDimY = STR(ElevDimUnit, DimY)if dop=0 then TextDimf = STR(ElevDimUnit, Dimf) else TextDimf=""if strstr(addText,"абс")>0 then	Dimf = INT((symb - DimOrigin + GLOB_PROJECT_ALTITUDE + RoundValue/2) /RoundValue) *RoundValue	TextDimf = str(Dimf,6,2)endifIF bShowPlus THEN	IF DimY > EPS THEN TextDimY = "+" + TextDimY	IF ABS(DimY) < EPS AND bPlusMinus THEN TextDimY = "±" + TextDimYENDIFIF GLOB_CONTEXT <> 5 AND txtOption = "Вычисленное значение" THEN	PARAMETERS customTextDimY = TextDimYENDIFIF txtOption = "Вычисленное значение" THEN	dimText = TextDimY	LOCK "customTextDimY"ELSE	dimText = customTextDimYENDIFIF GLOB_MODPAR_NAME = "txtOption" AND txtOption = "Вычисленное значение" THEN	PARAMETERS customTextDimY = ""ENDIF! ======================================================! Составление текстовых блоков! ======================================================	PEN penFont	interval = ""	IF superText <> "" THEN interval = " "		PARAGRAPH "UpPRG" 3, (1 - SYMB_MIRRORED), 0, SYMB_MIRRORED, 1		SET STYLE "normalText"			"" + dimText		SET STYLE "superText"			interval + superText	ENDPARAGRAPH	TEXTBLOCK "UpTextBlock" 0, 9, 0, 1, 1, 1, "UpPRG"		PARAGRAPH "DownPRG" 3, (1 - SYMB_MIRRORED), 0, SYMB_MIRRORED, 1		SET STYLE "smallText"			"" + addText + TextDimf	ENDPARAGRAPH	TEXTBLOCK "DownTextBlock" 0, 9, 0, 1, 1, 1, "DownPRG"	! ======================================================! Запрос параметров текст.стилей для определения рамеров! ======================================================	n = REQUEST ("TEXTBLOCK_INFO",  "UpTextBlock", wUpTextBlock, hUpTextBlock)	! габаритов верхнего текст.блока	n = REQUEST ("TEXTBLOCK_INFO",  "DownTextBlock", wDownTextBlock, hDownTextBlock)	! габаритов нижнего текст.блока	n = REQUEST ("Height_of_style", "normalText", height1, descent1, leading1)	! шрифта Размерного текста 	n = REQUEST ("Height_of_style", "smallText",  height2, descent2, leading2)	! шрифта Дополнительного текста 	! ======================================================! Установка длины полки и подложки ! ======================================================	LOpaque = (wUpTextBlock + sizeArrow )/1000*A_	LShelf = (MAX(wUpTextBlock, wDownTextBlock*maxShelf - 0.3 *sizeArrow *(txtOrientMarker = "Внизу")) + sizeArrow )/1000*A_	! ======================================================! Установка высоты текст.стиля с учетом "плохих" шрифтов! ======================================================	IF height1 - (AC_TextSize_1 + descent1 + leading1) < 1/2*descent1 THEN \		hFontStyle1 = (descent1*5/3 + AC_TextSize_1) ELSE hFontStyle1 = height1	IF height2 - (AC_TextSize_1*3/4 + descent2 + leading2) < 1/2*descent2 THEN \		hFontStyle2 = (descent2*2 + AC_TextSize_1*3/4) ELSE hFontStyle2 = height2	! ======================================================! Установка минимального отступа полки! ======================================================	UpPos   = INT( MAX(sizeArrow *multiplierSA, sizeArrow + (hFontStyle2 - descent2) *(addText<>"")))	! min отступ вверх	DownPos = INT(-MAX(sizeArrow *multiplierSA, sizeArrow + hFontStyle1))				! min отступ вниз	! ======================================================! Удержание ориентации маркера (верх/низ) при редактировании нескольких отметок сразу. (работает)! Удержание разблокированного отступа полки на нужном растоянии при смене масштаба. (работает)! Удержание разблокированного отступа полки на нужном растоянии! при редактировании нескольких отметок сразу. (сделать неудалось)! ======================================================	IF NOT(GLOB_MODPAR_NAME = "orientMarker_sc") AND NOT(GLOB_MODPAR_NAME = "orientMarker_fix") THEN		IF txtOrientMarker = "Вверху" THEN			IF orientMarker_sc > 0 AND orientMarker_sc < UpPos/1000*A_   THEN	PARAMETERS orientMarker_sc = UpPos/1000*A_			IF FixMarkerSize = 0 THEN PARAMETERS orientMarker_sc = MAX(UpPos /1000*A_, orientMarker_sc)			IF FixMarkerSize = 1 THEN PARAMETERS orientMarker_fix = UpPos, orientMarker_sc = UpPos /1000*A_		ENDIF		IF txtOrientMarker = "Внизу" THEN			IF orientMarker_sc < 0 AND orientMarker_sc > DownPos/1000*A_ THEN	PARAMETERS orientMarker_sc = DownPos/1000*A_			IF FixMarkerSize = 0 THEN PARAMETERS orientMarker_sc = MIN(DownPos /1000*A_, orientMarker_sc)			IF FixMarkerSize = 1 THEN PARAMETERS orientMarker_fix = DownPos, orientMarker_sc = DownPos /1000*A_		ENDIF	ENDIF