
eps=0.00001
main_cp_num=vardim1(ac_coords)
cp_all_num=vardim1(ac_coords)

if ac_pitch < EPS then
	if rooftype=`Волнистый Лист` or rooftype=`Профилированный Лист` then temp_zz = wawe_h
	if rooftype=`Стоячий Фальц` then temp_zz = seam_height
	if rooftype=`Обычная Черепица` or rooftype=`Скругленная Черепица` or rooftype=`Итальянская Черепица` then temp_zz = 0.15+tile_thk
else
	temp_zz = 0
endif

r=1
cp_num=0
for i=1 to vardim1(ac_coords)
	if ac_coords[i][1]>1 1/2" then cp_num=cp_num+1
next i

If cp_num=1 And (abs(ac_coords[1][2]-ac_coords[vardim1(ac_coords)][2])>eps Or abs(ac_coords[1][3]-ac_coords[vardim1(ac_coords)][3])>eps) Then
	ac_coords[vardim1(ac_coords)][1]=1"
	last_line=vardim1(ac_coords)+1
	ac_coords[last_line][1]=2"
	ac_coords[last_line][2]=ac_coords[1][2]
	ac_coords[last_line][3]=ac_coords[1][3]
EndIf

!------------------
! Scan the polygons
!------------------

exam=1
crd_end = 0
dim crd_begend[][]
for i=1 to cp_num
	crd_num=0
	crd_beg=crd_end+1
	r=crd_beg

	while  ac_coords[r][1]<1 1/2" and exam<>0 do   !ac_coords[r][1]>eps and
		crd_num=crd_num+1
		r=r+1
		if r=vardim1(ac_coords) then
			exam=0
		endif
	endwhile
	crd_end=crd_beg+crd_num

	crd_begend[i][1]=crd_beg
	crd_begend[i][2]=crd_end
next i

! ---------------------------------------------------
! Scan the global boundary rectangle for the required
! boundary rectangle in the local coordinate system
! ---------------------------------------------------

oversize=max(0.5,3/2*seam_space)	! Oversize for the cutting body

dim whole_loc_poly[][]

for i=1 to vardim1(ac_coords)
	put ac_coords[i][2]
next i

min_x=min(use(nsp))
max_x=max(get(nsp))

for i=1 to vardim1(ac_coords)
	put ac_coords[i][3]
next i

min_y=min(use(nsp))
max_y=max(get(nsp))

whole_loc_poly[1][1]=min_x-oversize
whole_loc_poly[1][2]=min_y-oversize
whole_loc_poly[1][3]=min_x-oversize
whole_loc_poly[1][4]=max_y+oversize
whole_loc_poly[1][5]=max_x+oversize
whole_loc_poly[1][6]=max_y+oversize
whole_loc_poly[1][7]=max_x+oversize
whole_loc_poly[1][8]=min_y-oversize

if rooftype=`Обычная Черепица` then tile_type=1
if rooftype=`Скругленная Черепица` then tile_type=2
if rooftype=`Итальянская Черепица` then tile_type=3

if gs_detlevel_3D=`Детальный` then gs_detlevel_3Dm=2
if gs_detlevel_3D=`Простой` then gs_detlevel_3Dm=1
if gs_detlevel_3D=`Откл.` then gs_detlevel_3Dm=0

if rooftype=`Обычная Черепица` or rooftype=`Скругленная Черепица` or rooftype=`Итальянская Черепица` then
	fudgez=batten_height
else
	if rooftype=`Стоячий Фальц` then
		fudgez=seam_dist
	else
		fudgez=wawe_dist
	endif
endif
