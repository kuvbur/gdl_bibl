
if gs_detlevel_3D_m = 0 then end
if not(gs_shadow) then shadow off

! -----------------------------------------------------------------------------
! 3D Hotspots
! -----------------------------------------------------------------------------

unID=1
hotspot 0, 0, 0, unID : unID = unID + 1
hotspot a, 0, 0, unID : unID = unID + 1
hotspot 0, b, 0, unID : unID = unID + 1
hotspot 0, 0, zzyzx, unID : unID = unID + 1
hotspot a, 0, zzyzx, unID : unID = unID + 1
hotspot 0, b, zzyzx, unID : unID = unID + 1

! -----------------------------------------------------------------------------
! Styles and Tap
! -----------------------------------------------------------------------------

pen gs_cont_pen

gosub iStyle
if gs_detlevel_3D_m <> 3 and gs_tap_type_m <> 0 then
	gosub "tap"
endif

! -----------------------------------------------------------------------------
! MEP Connections
! -----------------------------------------------------------------------------
if bShowMEP then
	gosub "mepconnection"
else
	unID = 100
	hotspot 0, ConPosY_3, ConPosZ_3, unID, ConPosX_3, 1+128: unID = unID+1
	hotspot -0.1, ConPosY_3, ConPosZ_3, unID, ConPosX_3, 3: unID = unID+1
	hotspot ConPosX_3, ConPosY_3, ConPosZ_3, unID, ConPosX_3, 2: unID = unID+1

	hotspot ConPosX_3, 0, ConPosZ_3, unID, ConPosY_3, 1+128: unID = unID+1
	hotspot ConPosX_3, -0.1, ConPosZ_3, unID, ConPosY_3, 3: unID = unID+1
	hotspot ConPosX_3, ConPosY_3, ConPosZ_3, unID, ConPosY_3, 2: unID = unID+1
endif

end

! =============================================================================
! SUBRUTINES
!
! =============================================================================

! -----------------------------------------------------------------------------
! Bathtub Corner Style 1
! -----------------------------------------------------------------------------

1:
	d = zzyzx

	mulx a / 1.483733
	muly b / 1.483733
	mulz d / 0.51

	if GLOB_CONTEXT > 40 and GLOB_CONTEXT < 50 then
		resol 24
		roty -90
		rotx -90
		revolve 3, 90, 1+2+4+8+16+32,
					0.51,     1.45,     0,
					0.46,     1.483733,     0,
					0.0,     1.483733,     0
		del 2
	endif

	if gs_detlevel_3D_m = 2 then
		resol gs_resol
		material sdmat
		addz 0.51
		poly_  14,
			0,0,0,
			1.450,0,0,
			0,1,800,
			0,1.450,1000,
			0,0,-1,
			0.548,1.2774,600,
			1,-0.429,800,
			1.2774,0.548,1000,
			0.6843,0.1891,1000,
			0.6047,0.1865,1000,
			0.1865,0.6047,1000,
			0.1891,0.6843,1000,
			0.548,1.2774,1000,
			0.548,1.2774,-1
		del 1

		roty -90
		rotx -90
		material sdmat

		revolve 34, 90, 4+8+16+32,
					0.51,     1.45,     0,
					0.507338,     1.450579,     1,
					0.499451,     1.454446,     1,
					0.49691,     1.455851,     1,
					0.494298,     1.458018,     1,
					0.492103,     1.460606,     1,
					0.491246,     1.462071,     1,
					0.489648,     1.464805,     1,
					0.485551,     1.469634,     1,
					0.480677,     1.473679,     1,
					0.475175,     1.476815,     1,
					0.469212,     1.478949,     1,
					0.462969,     1.480015,     1,
					0.46,     1.479998,     0,
					0.46,     1.469998,     2,
					0.02656,     1.469998,     0,
					0.025636,     1.470035,     1,
					0.024479,     1.470298,     1,
					0.023386,     1.470758,     1,
					0.02239,     1.4714,     1,
					0.02152,     1.472206,     1,
					0.020803,     1.473151,     1,
					0.020261,     1.474205,     1,
					0.01991,     1.475338,     1,
					0.019836,     1.475926,     1,
					0.019699,     1.476568,     1,
					0.019208,     1.477785,     1,
					0.018512,     1.478898,     1,
					0.017634,     1.479873,     1,
					0.0166,     1.480681,     1,
					0.015441,     1.481297,     1,
					0.014193,     1.481702,     1,
					0.013563,     1.481791,     1,
					0.0,     1.483733,     0
		del 2

		rotx 90
		poly_ 5,
			0,0,1,
			1.45,0,0,
			1.45,0.51,1,
			0,0.51,1,
			0,0,-1

		roty 90
		poly_ 5,
			0,0,1,
			1.45,0,0,
			1.45,0.51,1,
			0,0.51,1,
			0,0,-1
			del 2

		material gs_tub_mat

		roty -90
		add 0.1,0.41,-0.9558
		rotx 129.134
		revolve   20,  164.084, 0,
				0.0,     0.1899,     0,
				0.000475,     0.200582,     1,
				0.003462,     0.213361,     1,
				0.008623,     0.225427,     1,
				0.015801,     0.236414,     1,
				0.024777,     0.245987,     1,
				0.03528,     0.253856,     1,
				0.046989,     0.259782,     1,
				0.059549,     0.263584,     1,
				0.066064,     0.264366,     1,
				0.365957,     0.300353,     1,
				0.370301,     0.300874,     1,
				0.378674,     0.303409,     1,
				0.38648,     0.30736,     1,
				0.393482,     0.312606,     1,
				0.399466,     0.318988,     1,
				0.404251,     0.326312,     1,
				0.407692,     0.334356,     1,
				0.409683,     0.342875,     1,
				0.41,     0.349997,     0
		del 2

		add 0.10, 0.9558, -0.41
		rotx -23.218
		revolve   20,  164.084, 0,
				0.0,     0.1899,     0,
				0.000475,     0.200582,     1,
				0.003462,     0.213361,     1,
				0.008623,     0.225427,     1,
				0.015801,     0.236414,     1,
				0.024777,     0.245987,     1,
				0.03528,     0.253856,     1,
				0.046989,     0.259782,     1,
				0.059549,     0.263584,     1,
				0.066064,     0.264366,     1,
				0.365957,     0.300353,     1,
				0.370301,     0.300874,     1,
				0.378674,     0.303409,     1,
				0.38648,     0.30736,     1,
				0.393482,     0.312606,     1,
				0.399466,     0.318988,     1,
				0.404251,     0.326312,     1,
				0.407692,     0.334356,     1,
				0.409683,     0.342875,     1,
				0.41,     0.349997,     0
		del 3

		roty -90
		rotx -66.782
		addx 0.1
		revolve 20, 43.564, 0,
				0.0,     1.2299,     0,
				0.000475,     1.240582,     1,
				0.003462,     1.253361,     1,
				0.008623,     1.265427,     1,
				0.015801,     1.276414,     1,
				0.024777,     1.285987,     1,
				0.03528,     1.293856,     1,
				0.046989,     1.299782,     1,
				0.059549,     1.303584,     1,
				0.066064,     1.304366,     1,
				0.365957,     1.340353,     1,
				0.370301,     1.340874,     1,
				0.378674,     1.343409,     1,
				0.38648,     1.34736,     1,
				0.393482,     1.352606,     1,
				0.399466,     1.358988,     1,
				0.404251,     1.366312,     1,
				0.407692,     1.374356,     1,
				0.409683,     1.382875,     1,
				0.41,     1.389997,     1

		revolve  10, 43.564, 0,
				0.0,     0.850138,     0,
				0.002279,     0.830652,     1,
				0.006767,     0.818321,     1,
				0.013329,     0.806956,     1,
				0.021764,     0.796902,     1,
				0.031817,     0.788467,     1,
				0.043183,     0.781905,     1,
				0.055514,     0.777417,     1,
				0.066064,     0.775672,     1,
				0.205,     0.759,     0
		del 3

		roty -90
		add 0.305, 0.36, -0.36
		rotx 35.3410
		revolve   11, 199.3179, 0,
				0.205,     0.30,     0,
				0.204683,     0.292837,     1,
				0.202692,     0.284318,     1,
				0.199251,     0.276274,     1,
				0.194466,     0.26895,     1,
				0.188482,     0.262568,     1,
				0.18148,     0.257322,     1,
				0.173674,     0.253371,     1,
				0.165301,     0.250836,     1,
				0.160957,     0.250315,     1,
				0.0,     0.231,     0
		del 3

		roty -90
		add 0.305, 0.1575, -0.6455
		rotx -50.8660
		revolve   10, 105.5249, 0,
				0.205,     0.05,     0,
				0.203481,     0.06299,     1,
				0.200488,     0.071212,     1,
				0.196114,     0.078788,     1,
				0.19049,     0.08549,     1,
				0.183788,     0.091114,     1,
				0.176212,     0.095488,     1,
				0.16799,     0.098481,     1,
				0.160957,     0.099644,     1,
			   0.0,     0.1190,     0
		del 2

		add 0.305, 0.6455, -0.1575
		rotx -144.6590
		revolve   10, 105.5249, 0,
				0.205,     0.05,     0,
				0.203481,     0.06299,     1,
				0.200488,     0.071212,     1,
				0.196114,     0.078788,     1,
				0.19049,     0.08549,     1,
				0.183788,     0.091114,     1,
				0.176212,     0.095488,     1,
				0.16799,     0.098481,     1,
				0.160957,     0.099644,     1,
			   0.0,     0.1190,     0
		del 2

		add 0.10, 0.41, -0.9558
		rotx  113.2180
		revolve  11, 15.9160, 0,
				0.0,     0.1899,     0,
				0.000475,     0.200582,     1,
				0.003462,     0.213361,     1,
				0.008623,     0.225427,     1,
				0.015801,     0.236414,     1,
				0.024777,     0.245987,     1,
				0.03528,     0.253856,     1,
				0.046989,     0.259782,     1,
				0.059549,     0.263584,     1,
				0.066064,     0.264366,     1,
				0.205,     0.281038,     0
		del 2

		add 0.10, 0.9558, -0.41
		rotx  140.8660
		revolve  11, 15.9160, 0,
				0.0,     0.1899,     0,
				0.000475,     0.200582,     1,
				0.003462,     0.213361,     1,
				0.008623,     0.225427,     1,
				0.015801,     0.236414,     1,
				0.024777,     0.245987,     1,
				0.03528,     0.253856,     1,
				0.046989,     0.259782,     1,
				0.059549,     0.263584,     1,
				0.066064,     0.264366,     1,
				0.205,     0.281038,     0
		del 3

		addz 0.305
		poly_  9,
			0.2327,0.7378,600,
			0.41,0.9558,900,
			0,15.9160,4000,
			0.6975,0.2992,1000,
			0.7378,0.2327,1000,
			0.6455,0.1575,900,
			0,105.5249,4000,
			0.1865,0.6047,1000,
			0.2327,0.7378,1000
		del 1

		prism_ 7, 0.1,
			0.4849,1.1303,600,
			1,-0.429,800,
			1.1303,0.4849,1000,
			0.7813,0.3351,1000,
			0.3351,0.7813,1000,
			0.4849,1.1303,1000,
			0.4849,1.1303,-1
		del TOP

		add ConPosX_3, ConPosY_3, 0.10*d/0.51
		cylind 0.005, 0.025
		del 1
	endif

	if gs_detlevel_3D_m = 1 then
		resol 28
		material sdmat
		addz 0.51
		poly_  36,
			0,0,0,
			1.450,0,0,
			0,1,800,
			0,1.450,1000,
			0,0,-1,
			0.8507755582692, 1.099214542053,      0,
			0.5479127473428, 1.277462510564,      0,
			0.3847973852374, 1.304888424641,      0,
			0.2272486152199, 1.254295948666,      0,
			0.1105491552277, 1.136982481422,      0,
			0.0607841286472, 0.9791703916165,      0,
			0.08907721041877, 0.816134459739,      0,
			0.1885905668549, 0.6849940202961,      0,
			0.2056367277525, 0.659022405159,      0,
			0.2046367238374, 0.628822792024,      0,
			0.1862101569235, 0.6044333111199,      0,
			0.09952544988114, 0.5088388683791,      0,
			0.06106511788652, 0.3852574000206,      0,
			0.07824512515772, 0.2569748064665,      0,
			0.147867780524, 0.1478681507642,      0,
			0.2569743147117, 0.07824530497103,      0,
			0.3852568782807, 0.0610650738045,      0,
			0.508838413765, 0.0995251901087,      0,
			0.6044345365316, 0.1862111165517,      0,
			0.6288228742932, 0.2046367529446,      0,
			0.6590224891734, 0.2056367041514,      0,
			0.6849943453525, 0.1885903201923,      0,
			0.816134459739, 0.08907721041877,      0,
			0.9791703916165, 0.0607841286472,      0,
			1.136982481422, 0.1105491552277,      0,
			1.254295948666, 0.2272486152199,      0,
			1.304888424641, 0.3847973852374,      0,
			1.277462510564, 0.5479127473428,      0,
			1.099214542053, 0.8507755582692,      0,
			0.8507755582692, 1.099214542053,      0,
			0.8507755582692, 1.099214542053,      -1
		del 1

		roty -90
		rotx -90
		revolve 11, 90, 4+8+16+32,
				0.51,     1.45,     0,
				0.494298,     1.458018,     1,
				0.485551,     1.469634,     1,
				0.475175,     1.476815,     1,
				0.46,     1.479998,     0,
				0.46,     1.469998,     2,

				0.02656,     1.469998,     0,
				0.02152,     1.472206,     1,
				0.018512,     1.478898,     1,
				0.013563,     1.481791,     1,
				0.0,     1.483733,     0
		del 2

		rotx 90
		poly_ 5,
			0,0,1,
			1.45,0,0,
			1.45,0.51,1,
			0,0.51,1,
			0,0,-1

		roty 90
		poly_ 5,
			0,0,1,
			1.45,0,0,
			1.45,0.51,1,
			0,0.51,1,
			0,0,-1
			del 2

		resol 14
		roty -90
		add 0.1, 0.41, -0.9558
		rotx 129.134
		revolve   7,  164.084, 0,
				0.0,     0.1899,     0,
				0.015801,     0.236414,     1,
				0.066064,     0.264366,     1,
				0.365957,     0.300353,     1,
				0.38648,     0.30736,     1,
				0.404251,     0.326312,     1,
				0.41,     0.349997,     0
		del 2

		add 0.10, 0.9558, -0.41
		rotx -23.218
		revolve   7,  164.084, 0,
				0.0,     0.1899,     0,
				0.015801,     0.236414,     1,
				0.066064,     0.264366,     1,
				0.365957,     0.300353,     1,
				0.38648,     0.30736,     1,
				0.404251,     0.326312,     1,
				0.41,     0.349997,     0
		del 3

		resol 24
		roty -90
		rotx -66.782
		addx 0.1
		revolve 7, 43.564, 0,
				0.0,     1.2299,     0,
				0.015801,     1.276414,     1,
				0.066064,     1.304366,     1,
				0.365957,     1.340353,     1,
				0.38648,     1.34736,     1,
				0.404251,     1.366312,     1,
				0.41,     1.389997,     1

		revolve  3, 43.564, 0,
				0.0,     0.850138,     0,
				0.021764,     0.796902,     1,
				0.205,     0.759,     0
		del 3

		resol 14
		roty -90
		add 0.305, 0.36, -0.36
		rotx 35.3410
		revolve   5, 199.3179, 0,
				0.205,     0.30,     0,
				0.199251,     0.276274,     1,
				0.18148,     0.257322,     1,
				0.160957,     0.250315,     1,
				0.0,     0.231,     0
		del 3

		resol 10
		roty -90
		add 0.305, 0.1575, -0.6455
		rotx -50.8660
		revolve   5, 105.5249, 0,
				0.205,     0.05,     0,
				0.199251,     0.0739,     1,
				0.18148,     0.093114,     1,
				0.160957,     0.099644,     1,
				0.0,     0.1190,     0
		del 2

		add 0.305, 0.6455, -0.1575
		rotx -144.6590
		revolve   5, 105.5249, 0,
				0.205,     0.05,     0,
				0.199251,     0.0739,     1,
				0.18148,     0.093114,     1,
				0.160957,     0.099644,     1,
				0.0,     0.1190,     0
		del 2

		add 0.10, 0.41, -0.9558
		rotx  113.2180
		revolve  4, 15.9160, 0,
				0.0,     0.1899,     0,
				0.015801,     0.236414,     1,
				0.066064,     0.264366,     1,
				0.205,     0.281038,     0
		del 2

		add 0.10, 0.9558, -0.41
		rotx  140.8660
		revolve  4, 15.9160, 0,
				0.0,     0.1899,     0,
				0.015801,     0.236414,     1,
				0.066064,     0.264366,     1,
				0.205,     0.281038,     0
		del 3

		resol 24
		addz 0.305
		poly_  9,
			0.2327,0.7378,600,
			0.41,0.9558,900,
			0,15.9160,4000,
			0.6975,0.2992,1000,
			0.7378,0.2327,1000,
			0.6455,0.1575,900,
			0,105.5249,4000,
			0.1865,0.6047,1000,
			0.2327,0.7378,1000
		del 1

		prism_ 7, 0.1,
			0.4849,1.1303,600,
			1,-0.429,800,
			1.1303,0.4849,1000,
			0.7813,0.3351,1000,
			0.3351,0.7813,1000,
			0.4849,1.1303,1000,
			0.4849,1.1303,-1
		del TOP

		add ConPosX_3, ConPosY_3, 0.10*d/0.51
		cylind 0.005, 0.025
		del 1
	endif

	if gs_detlevel_3D_m = 3 then
		resol 28
		material sdmat
		addz 0.51
		poly_ 36,
			0,0,0,
			1.450,0,0,
			0,1,800,
			0,1.450,1000,
			0,0,-1,
			0.8507755582692, 1.099214542053,      0,
			0.5479127473428, 1.277462510564,      0,
			0.3847973852374, 1.304888424641,      0,
			0.2272486152199, 1.254295948666,      0,
			0.1105491552277, 1.136982481422,      0,
			0.0607841286472, 0.9791703916165,      0,
			0.08907721041877, 0.816134459739,      0,
			0.1885905668549, 0.6849940202961,      0,
			0.2056367277525, 0.659022405159,      0,
			0.2046367238374, 0.628822792024,      0,
			0.1862101569235, 0.6044333111199,      0,
			0.09952544988114, 0.5088388683791,      0,
			0.06106511788652, 0.3852574000206,      0,
			0.07824512515772, 0.2569748064665,      0,
			0.147867780524, 0.1478681507642,      0,
			0.2569743147117, 0.07824530497103,      0,
			0.3852568782807, 0.0610650738045,      0,
			0.508838413765, 0.0995251901087,      0,
			0.6044345365316, 0.1862111165517,      0,
			0.6288228742932, 0.2046367529446,      0,
			0.6590224891734, 0.2056367041514,      0,
			0.6849943453525, 0.1885903201923,      0,
			0.816134459739, 0.08907721041877,      0,
			0.9791703916165, 0.0607841286472,      0,
			1.136982481422, 0.1105491552277,      0,
			1.254295948666, 0.2272486152199,      0,
			1.304888424641, 0.3847973852374,      0,
			1.277462510564, 0.5479127473428,      0,
			1.099214542053, 0.8507755582692,      0,
			0.8507755582692, 1.099214542053,      0,
			0.8507755582692, 1.099214542053,      -1
		del 1

		roty -90
		rotx -90
		revolve 3, 90, 4+8+16+32,
				0.51,     1.45,     0,
				0.46,     1.483733,     0,
				0.0,     1.483733,     0
		del 2

		rotx 90
		poly_ 5,
			0,0,1,
			1.45,0,0,
			1.45,0.51,1,
			0,0.51,1,
			0,0,-1

		roty 90
		poly_ 5,
			0,0,1,
			1.45,0,0,
			1.45,0.51,1,
			0,0.51,1,
			0,0,-1
			del 2

		resol 14
		roty -90
		add 0.1, 0.41, -0.9558
		rotx 129.134
		revolve   3, 164.084, 0,
				0.0,     0.1899,     0,
				0.395,     0.316312,     1,
				0.41,     0.349997,     0
		del 2

		add 0.10, 0.9558, -0.41
		rotx -23.218
		revolve   3,  164.084, 0,
				0.0,     0.1899,     0,
				0.395,     0.316312,     1,
				0.41,     0.349997,     0
		del 3

		resol 24
		roty -90
		rotx -66.782
		addx 0.1
		revolve 3, 43.564, 0,
				0.0,     1.2299,     0,
				0.395,     1.356312,     1,
				0.41,     1.389997,     1

		revolve 2, 43.564, 0,
				0.0,     0.850138,     0,
				0.205,     0.784538,     0
		del 3

		resol 14
		roty -90
		add 0.305, 0.36, -0.36
		rotx 35.3410
		revolve 3, 199.3179, 0,
				0.205,     0.30,     0,
				0.19,     0.266315,     1,
				0.0,     0.2055,     0
		del 3
		resol 10
		roty -90
		add 0.305, 0.1575, -0.6455
		rotx -50.8660
		revolve 3, 105.5249, 0,
				0.205,     0.05,     0,
				0.19,     0.083685,     1,
				0.0,     0.1445,     0
		del 2
		add 0.305, 0.6455, -0.1575
		rotx -144.6590
		revolve 3, 105.5249, 0,
				0.205,     0.05,     0,
				0.19,     0.083685,     1,
				0.0,     0.1445,     0
		del 2

		add 0.10, 0.41, -0.9558
		rotx  113.2180
		revolve 2, 15.9160, 0,
				0.0,     0.1899,     0,
				0.205,     0.2555,     0
		del 2
		add 0.10, 0.9558, -0.41
		rotx  140.8660
		revolve 2, 15.9160, 0,
				0.0,     0.1899,     0,
				0.205,     0.2555,     0
		del 3

		resol 24
		addz 0.305
		poly_  20,
			0.7575846068745, 0.2486991825719,      1,
			0.6845799937112, 0.2966150749974,      1,
			0.5973031067072, 0.2937252160098,      1,
			0.5276310488279, 0.2411299807821,      1,
			0.4619543134291, 0.1815747552245,      1,
			0.3773009616223, 0.1552295755561,      1,
			0.2894274055775, 0.1669980339052,      1,
			0.2146894296589, 0.2146896832735,      1,
			0.166997910733, 0.2894277424296,      1,
			0.1552296057523, 0.3773013190141,      1,
			0.1815749331686, 0.4619546248397,      1,
			0.2411302733537, 0.527631256295,      1,
			0.2937251318902, 0.5973028689494,      1,
			0.2966151432047, 0.6845797509095,      1,
			0.2486993781963, 0.7575844477018,      1,
			0.3092889217897, 0.7209994703897,      1,
			0.4801922269857, 0.620415424201,      1,
			0.620415424201, 0.4801922269857,      1,
			0.7209994703897, 0.3092889217897,      1,
			0.7575846068745, 0.2486991825719,      1
		del 1

		addz 0.1
		poly_  21,
			0.8800208187625, 0.2358749710955,      1,
			0.9684802154532, 0.2205238217188,      1,
			1.054105280394, 0.2475251347233,      1,
			1.117756761491, 0.3108434701733,      1,
			1.145207028744, 0.3963256640959,      1,
			1.130320290192, 0.484864399491,      1,
			0.9726092684164, 0.7527849765973,      1,
			0.7527849765973, 0.9726092684164,      1,
			0.484864399491, 1.130320290192,      1,
			0.3963256640959, 1.145207028744,      1,
			0.3108434701733, 1.117756761491,      1,
			0.2475251347233, 1.054105280394,      1,
			0.2205238217188, 0.9684802154532,      1,
			0.2358749710955, 0.8800208187625,      1,
			0.2901472334228, 0.8084998834223,      1,
			0.3351504521036, 0.7812866269806,      1,
			0.5203440234446, 0.6722921361354,      1,
			0.6722921361354, 0.5203440234446,      1,
			0.7812866269806, 0.3351504521036,      1,
			0.8084998834223, 0.2901472334228,      1,
			0.8800208187625, 0.2358749710955,      1
		del 1
	endif
	del top

return

! -----------------------------------------------------------------------------
! Bathtub Corner Style 2
! -----------------------------------------------------------------------------

2:
	e = dep
	c = zzyzx

	if GLOB_CONTEXT > 40 and GLOB_CONTEXT < 50 then
		rotz 90
		mul b/1.65, a/1.65, 1
		add 0.83654,    -0.83654,0
		prism_ 11, c,
			-0.83654, 0.83654, 15,
			-0.83654, -0.81346, 15,
			-0.514641, -0.781756, 79,
			-0.205113, -0.687861, 79,
			0.080151, -0.535385, 79,
			0.330186, -0.330186, 79,
			0.535385, -0.080151, 79,
			0.687861, 0.205113, 79,
			0.781755, 0.514642, 79,
			0.813459, 0.83654, 15,
			-0.83654, 0.83654, -1
		del 3
	else

		if gs_detlevel_3D_m = 2 then
			resol gs_resol
			rotz 90
			mul b/1.65, a/1.65, 1
			add 0.83654,    -0.83654,0
			material sdmat
			extrude 11, 0, 0, c-0.01, 16+32,
					-0.83654,     0.83654,     0,
				   -0.83654,    -0.81346,     0,
				   -0.514641,    -0.781756,     1,
				   -0.205113,    -0.687861,     1,
					0.080151,    -0.535385,     1,
					0.330186,    -0.330186,     1,
					0.535385,    -0.080151,     1,
					0.687861,     0.205113,     1,
					0.781755,     0.514642,     1,
					0.813459,     0.83654,     0,
				   -0.83654,     0.83654,     -1

			gosub "texture coordinate system"

			addz c - 0.01
			material gs_tub_mat
			prism_ 44, 0.01,
					-0.83654,     0.83654,     15,
				   -0.83654,    -0.81346,     15,
				   -0.514641,    -0.781756,     13,
				   -0.205113,    -0.687861,     13,
					0.080151,    -0.535385,     13,
					0.330186,    -0.330186,     13,
					0.535385,    -0.080151,     13,
					0.687861,     0.205113,     13,
					0.781755,     0.514642,     13,
					0.813459,     0.83654,     15,
				   -0.83654,     0.83654,     -1,
				   -0.299574,     0.534653,     12,
				   -0.162351,     0.623475,     12,
				   -0.018888,     0.688336,     12,
					0.125301,     0.726746,     12,
					0.264674,     0.737226,     12,
					0.393876,     0.719376,     12,
					0.507942,     0.673881,     12,
					0.601041,     0.601041,     12,
					0.63931,     0.542513,     12,
					0.651563,     0.461689,     12,
					0.638778,     0.363123,     12,
					0.601444,     0.250602,     12,
					0.540998,     0.128451,     12,
					0.459761,     0.001363,     12,
					0.360856,    -0.125777,     12,
					0.248083,    -0.248083,     12,
					0.125777,    -0.360856,     12,
				   -0.001363,    -0.459761,     12,
				   -0.128451,    -0.540998,     12,
				   -0.250602,    -0.601445,     12,
				   -0.363122,    -0.638778,     12,
				   -0.461689,    -0.651564,     12,
				   -0.542512,    -0.63931,     12,
				   -0.602488,    -0.602488,     12,
				   -0.67388,    -0.507942,     12,
				   -0.719376,    -0.393877,     12,
				   -0.737226,    -0.264675,     12,
				   -0.726745,    -0.125301,     12,
				   -0.688336,     0.018887,     12,
				   -0.623475,     0.16235,     12,
				   -0.534654,     0.299574,     12,
				   -0.425286,     0.425285,     12,
				   -0.299574,     0.534653,     -1

			addz -0.1
			extrude 33, 0, 0, 0.1, 4,
				   -0.299574,     0.534653,     1,
				   -0.162351,     0.623475,     1,
				   -0.018888,     0.688336,     1,
					0.125301,     0.726746,     1,
					0.264674,     0.737226,     1,
					0.393876,     0.719376,     1,
					0.507942,     0.673881,     1,
					0.601041,     0.601041,     1,
					0.63931,     0.542513,     1,
					0.651563,     0.461689,     1,
					0.638778,     0.363123,     1,
					0.601444,     0.250602,     1,
					0.540998,     0.128451,     1,
					0.459761,     0.001363,     1,
					0.360856,    -0.125777,     1,
					0.248083,    -0.248083,     1,
					0.125777,    -0.360856,     1,
				   -0.001363,    -0.459761,     1,
				   -0.128451,    -0.540998,     1,
				   -0.250602,    -0.601445,     1,
				   -0.363122,    -0.638778,     1,
				   -0.461689,    -0.651564,     1,
				   -0.542512,    -0.63931,     1,
				   -0.602488,    -0.602488,     1,
				   -0.67388,    -0.507942,     1,
				   -0.719376,    -0.393877,     1,
				   -0.737226,    -0.264675,     1,
				   -0.726745,    -0.125301,     1,
				   -0.688336,     0.018887,     1,
				   -0.623475,     0.16235,     1,
				   -0.534654,     0.299574,     1,
				   -0.425286,     0.425285,     1,
				   -0.299574,     0.534653,     -1

			poly 32,
				   -0.299574,     0.534653,
				   -0.162351,     0.623475,
				   -0.018888,     0.688336,
					0.125301,     0.726746,
					0.264674,     0.737226,
					0.393876,     0.719376,
					0.507942,     0.673881,
					0.601041,     0.601041,
					0.542512,     0.63931,
					0.461689,     0.651564,
					0.363122,     0.638778,
					0.250602,     0.601445,
					0.128451,     0.540998,
					0.001363,     0.459761,
				   -0.125777,     0.360856,
				   -0.248083,     0.248083,
				   -0.360856,     0.125777,
				   -0.459761,    -0.001363,
				   -0.540998,    -0.128451,
				   -0.601444,    -0.250602,
				   -0.638778,    -0.363123,
				   -0.651563,    -0.461689,
				   -0.63931,    -0.542513,
				   -0.602488,    -0.602488,
				   -0.67388,    -0.507942,
				   -0.719376,    -0.393877,
				   -0.737226,    -0.264675,
				   -0.726745,    -0.125301,
				   -0.688336,     0.018887,
				   -0.623475,     0.16235,
				   -0.534654,     0.299574,
				   -0.425286,     0.425285

			addz -e + 0.11
			ruled 32, 1+4+16,
					-0.063078,     0.249758,     1,
					0.035751,     0.330436,     1,
					0.133206,     0.398415,     1,
					0.225542,     0.451084,     1,
					0.30921,     0.486417,     1,
					0.380995,     0.503058,     1,
					0.438139,     0.500367,     1,
					0.477297,     0.477297,     1,
					0.500366,     0.43814,     1,
					0.503058,     0.380996,     1,
					0.486417,     0.30921,     1,
					0.451083,     0.225542,     1,
					0.398415,     0.133206,     1,
					0.330436,     0.035751,     1,
					0.249758,    -0.063077,     1,
					0.159482,    -0.159482,     1,
					0.063078,    -0.249758,     1,
				   -0.035751,    -0.330436,     1,
				   -0.133206,    -0.398415,     1,
				   -0.225542,    -0.451084,     1,
				   -0.30921,    -0.486417,     1,
				   -0.380995,    -0.503058,     1,
				   -0.438139,    -0.500367,     1,
				   -0.478446,    -0.478446,     1,
				   -0.500366,    -0.43814,     1,
				   -0.503058,    -0.380996,     1,
				   -0.486417,    -0.30921,     1,
				   -0.451083,    -0.225542,     1,
				   -0.398415,    -0.133206,     1,
				   -0.330436,    -0.035751,     1,
				   -0.249758,     0.063077,     1,
				   -0.159482,     0.159482,     1,

					-0.125777,     0.360856,     e-0.11,
					0.001363,     0.459761,     e-0.11,
					0.128451,     0.540998,     e-0.11,
					0.250602,     0.601445,     e-0.11,
					0.363122,     0.638778,     e-0.11,
					0.461689,     0.651564,     e-0.11,
					0.542512,     0.63931,     e-0.11,
					0.60104,     0.601041,     e-0.11,
					0.63931,     0.542513,     e-0.11,
					0.651563,     0.461689,     e-0.11,
					0.638778,     0.363123,     e-0.11,
					0.601444,     0.250602,     e-0.11,
					0.540998,     0.128451,     e-0.11,
					0.459761,     0.001363,     e-0.11,
					0.360856,    -0.125777,     e-0.11,
					0.248083,    -0.248083,     e-0.11,
					0.125777,    -0.360856,     e-0.11,
				   -0.001363,    -0.459761,     e-0.11,
				   -0.128451,    -0.540998,     e-0.11,
				   -0.250602,    -0.601445,     e-0.11,
				   -0.363122,    -0.638778,     e-0.11,
				   -0.461689,    -0.651564,     e-0.11,
				   -0.542512,    -0.63931,     e-0.11,
				   -0.602488,    -0.602488,     e-0.11,
				   -0.63931,    -0.542513,     e-0.11,
				   -0.651563,    -0.461689,     e-0.11,
				   -0.638778,    -0.363123,     e-0.11,
				   -0.601444,    -0.250602,     e-0.11,
				   -0.540998,    -0.128451,     e-0.11,
				   -0.459761,    -0.001363,     e-0.11,
				   -0.360856,     0.125777,     e-0.11,
				   -0.248083,     0.248083,     e-0.11
			del 6

			add ConPosX_3, ConPosY_3, c-e
			cylind 0.005, 0.025
			del 1
		endif

		if gs_detlevel_3D_m = 1 then
			resol 12
			rotz 90
			mul b/1.65, a/1.65, 1
			add 0.83654,    -0.83654,0
			material sdmat
			extrude 11, 0, 0, c-0.01, 16+32,
					-0.83654,     0.83654,     0,
				   -0.83654,    -0.81346,     0,
				   -0.514641,    -0.781756,     1,
				   -0.205113,    -0.687861,     1,
					0.080151,    -0.535385,     1,
					0.330186,    -0.330186,     1,
					0.535385,    -0.080151,     1,
					0.687861,     0.205113,     1,
					0.781755,     0.514642,     1,
					0.813459,     0.83654,     0,
				   -0.83654,     0.83654,     -1

			gosub "texture coordinate system"

			addz c - 0.01
			material gs_tub_mat
			prism_ 31, 0.01,
					-0.83654,     0.83654,     15,
				   -0.83654,    -0.81346,     15,
				   -0.514641,    -0.781756,     13,
				   -0.205113,    -0.687861,     13,
					0.080151,    -0.535385,     13,
					0.330186,    -0.330186,     13,
					0.535385,    -0.080151,     13,
					0.687861,     0.205113,     13,
					0.781755,     0.514642,     13,
					0.813459,     0.83654,     15,
				   -0.83654,     0.83654,     -1,
				   -0.299574,     0.534653,     12,
				   -0.018888,     0.688336,     12,
					0.264674,     0.737226,     12,
					0.507942,     0.673881,     12,
					0.601041,     0.601041,     12,
					0.63931,     0.542513,     12,
					0.651563,     0.461689,     12,
					0.601444,     0.250602,     12,
					0.459761,     0.001363,     12,
					0.248083,    -0.248083,     12,
				   -0.001363,    -0.459761,     12,
				   -0.250602,    -0.601445,     12,
				   -0.461689,    -0.651564,     12,
				   -0.542512,    -0.63931,     12,
				   -0.602488,    -0.602488,     12,
				   -0.67388,    -0.507942,     12,
				   -0.737226,    -0.264675,     12,
				   -0.688336,     0.018887,     12,
				   -0.534654,     0.299574,     12,
				   -0.299574,     0.534653,     -1


			addz -0.1
			extrude 20, 0, 0, 0.1, 4,
				   -0.299574,     0.534653,     1,
				   -0.018888,     0.688336,     1,
					0.264674,     0.737226,     1,
					0.507942,     0.673881,     1,
					0.601041,     0.601041,     1,
					0.63931,     0.542513,     1,
					0.651563,     0.461689,     1,
					0.601444,     0.250602,     1,
					0.459761,     0.001363,     1,
					0.248083,    -0.248083,     1,
				   -0.001363,    -0.459761,     1,
				   -0.250602,    -0.601445,     1,
				   -0.461689,    -0.651564,     1,
				   -0.542512,    -0.63931,     1,
				   -0.602488,    -0.602488,     1,
				   -0.67388,    -0.507942,     1,
				   -0.737226,    -0.264675,     1,
				   -0.688336,     0.018887,     1,
				   -0.534654,     0.299574,     1,
				   -0.299574,     0.534653,     -1

			poly 26,
				   -0.299574,     0.534653,
				   -0.162351,     0.623475,
				   -0.018888,     0.688336,
					0.125301,     0.726746,
					0.264674,     0.737226,
					0.393876,     0.719376,
					0.507942,     0.673881,
					0.601041,     0.601041,
					0.542512,     0.63931,
					0.461689,     0.651564,
					0.250602,     0.601445,
					0.001363,     0.459761,
				   -0.248083,     0.248083,
				   -0.459761,    -0.001363,
				   -0.601444,    -0.250602,
				   -0.651563,    -0.461689,
				   -0.63931,    -0.542513,
				   -0.602488,    -0.602488,
				   -0.67388,    -0.507942,
				   -0.719376,    -0.393877,
				   -0.737226,    -0.264675,
				   -0.726745,    -0.125301,
				   -0.688336,     0.018887,
				   -0.623475,     0.16235,
				   -0.534654,     0.299574,
				   -0.425286,     0.425285

			addz -e + 0.11
			ruled 20, 1+4+16,
					0.035751,     0.330436,     1,
					0.225542,     0.451084,     1,
					0.380995,     0.503058,     1,
					0.438139,     0.500367,     1,
					0.477297,     0.477297,     1,
					0.500366,     0.43814,     1,
					0.503058,     0.380996,     1,
					0.451083,     0.225542,     1,
					0.330436,     0.035751,     1,
					0.159482,    -0.159482,     1,
				   -0.035751,    -0.330436,     1,
				   -0.225542,    -0.451084,     1,
				   -0.380995,    -0.503058,     1,
				   -0.438139,    -0.500367,     1,
				   -0.478446,    -0.478446,     1,
				   -0.500366,    -0.43814,     1,
				   -0.503058,    -0.380996,     1,
				   -0.451083,    -0.225542,     1,
				   -0.330436,    -0.035751,     1,
				   -0.159482,     0.159482,     1,

					0.001363,     0.459761,     e-0.11,
					0.250602,     0.601445,     e-0.11,
					0.461689,     0.651564,     e-0.11,
					0.542512,     0.63931,     e-0.11,
					0.60104,     0.601041,     e-0.11,
					0.63931,     0.542513,     e-0.11,
					0.651563,     0.461689,     e-0.11,
					0.601444,     0.250602,     e-0.11,
					0.459761,     0.001363,     e-0.11,
					0.248083,    -0.248083,     e-0.11,
				   -0.001363,    -0.459761,     e-0.11,
				   -0.250602,    -0.601445,     e-0.11,
				   -0.461689,    -0.651564,     e-0.11,
				   -0.542512,    -0.63931,     e-0.11,
				   -0.602488,    -0.602488,     e-0.11,
				   -0.63931,    -0.542513,     e-0.11,
				   -0.651563,    -0.461689,     e-0.11,
				   -0.601444,    -0.250602,     e-0.11,
				   -0.459761,    -0.001363,     e-0.11,
				   -0.248083,     0.248083,     e-0.11
			del top

			add ConPosX_3, ConPosY_3, c-e
			cylind 0.005, 0.025
			del 1
		endif

		if gs_detlevel_3D_m = 3 then
			resol 12
			rotz 90
			mul b/1.65, a/1.65, 1
			add 0.83654,    -0.83654,0
			material sdmat
			extrude 7, 0, 0, c, 16+32,
					-0.83654,     0.83654,     0,
				   -0.83654,    -0.81346,     0,
				   -0.205113,    -0.687861,     1,
					0.330186,    -0.330186,     1,
					0.687861,     0.205113,     1,
					0.813459,     0.83654,     0,
				   -0.83654,     0.83654,     -1

			gosub "texture coordinate system"

			addz c
			material gs_tub_mat
			poly_ 21,
					-0.83654,     0.83654,     1,
				   -0.83654,    -0.81346,     1,
				   -0.205113,    -0.687861,     1,
					0.330186,    -0.330186,     1,
					0.687861,     0.205113,     1,
					0.813459,     0.83654,     1,
				   -0.83654,     0.83654,     -1,
				   -0.299574,     0.534653,     1,
				   -0.018888,     0.688336,     1,
					0.264674,     0.737226,     1,
					0.507942,     0.673881,     1,
					0.63931,     0.542513,     1,
					0.601444,     0.250602,     1,
					0.248083,    -0.248083,     1,
				   -0.250602,    -0.601445,     1,
				   -0.542512,    -0.63931,     1,
				   -0.67388,    -0.507942,     1,
				   -0.737226,    -0.264675,     1,
				   -0.688336,     0.018887,     1,
				   -0.534654,     0.299574,     1,
				   -0.299574,     0.534653,     -1


			addz -0.1
			extrude 14, 0, 0, 0.1, 4,
				   -0.299574,     0.534653,     1,
				   -0.018888,     0.688336,     1,
					0.264674,     0.737226,     1,
					0.507942,     0.673881,     1,
					0.63931,     0.542513,     1,
					0.601444,     0.250602,     1,
					0.248083,    -0.248083,     1,
				   -0.250602,    -0.601445,     1,
				   -0.542512,    -0.63931,     1,
				   -0.67388,    -0.507942,     1,
				   -0.737226,    -0.264675,     1,
				   -0.688336,     0.018887,     1,
				   -0.534654,     0.299574,     1,
				   -0.299574,     0.534653,     -1

			poly 15,
				   -0.299574,     0.534653,
				   -0.018888,     0.688336,
					0.264674,     0.737226,
					0.507942,     0.673881,
					0.601041,     0.601041,
					0.461689,     0.651564,
					0.250602,     0.601445,
				   -0.248083,     0.248083,
				   -0.601444,    -0.250602,
				   -0.651563,    -0.461689,
				   -0.602488,    -0.602488,
				   -0.67388,    -0.507942,
				   -0.737226,    -0.264675,
				   -0.688336,     0.018887,
				   -0.534654,     0.299574

			addz -e+0.11
			ruled 12, 1+4+16,
					0.225542,     0.451084,     1,
					0.380995,     0.503058,     1,
					0.477297,     0.477297,     1,
					0.500366,     0.43814,     1,
					0.451083,     0.225542,     1,
					0.159482,    -0.159482,     1,
				   -0.225542,    -0.451084,     1,
				   -0.438139,    -0.500367,     1,
				   -0.478446,    -0.478446,     1,
				   -0.503058,    -0.380996,     1,
				   -0.451083,    -0.225542,     1,
				   -0.159482,     0.159482,     1,

					0.250602,     0.601445,     e-0.11,
					0.461689,     0.651564,     e-0.11,
					0.60104,     0.601041,     e-0.11,
					0.63931,     0.542513,     e-0.11,
					0.601444,     0.250602,     e-0.11,
					0.248083,    -0.248083,     e-0.11,
				   -0.250602,    -0.601445,     e-0.11,
				   -0.542512,    -0.63931,     e-0.11,
				   -0.602488,    -0.602488,     e-0.11,
				   -0.651563,    -0.461689,     e-0.11,
				   -0.601444,    -0.250602,     e-0.11,
				   -0.248083,     0.248083,     e-0.11
			del top
		endif
	endif

return


! -----------------------------------------------------------------------------
! MEP Connections
! -----------------------------------------------------------------------------

"mepconnection":

	if gs_detlevel_3D_m=1 or gs_detlevel_3D_m=3 then resol 8
	if gs_detlevel_3D_m=2 then resol 24

	if useSysMat then
		gs_tub_mat	= sMat
		sdmat 		= sMat
		gs_con_mat	= sMat
	endif

	if bWallMountedTap then
		if bFlipTap then
			ConEdit_1 = 12
			ConEdit_2 = 12
			corrMEPx = -xTapPos + tapDistCorn
			corrMEPy = 0
			corrMEPz = zTapPos
		else
			ConEdit_1 = 13
			ConEdit_2 = 13
			corrMEPx = 0
			corrMEPy = xTapPos + tapDistCorn
			corrMEPz = zTapPos
		endif
		add corrMEPx, corrMEPy, corrMEPz

	else
		ConEdit_1 = 16
		if ConPos_1 then ConEdit_1 = 17
		ConEdit_2 = 16
		if ConPos_2 then ConEdit_2 = 17

		corrMEPx = 0
		corrMEPy = 0
		corrMEPz = 0
	endif

	call "MEP_m_ConnectionsACL_4" parameters SetProgram = SetProgram,
		ui_current_con = ui_current_con,
		MEP_NumberConnections = MEP_NumberConnections,
		MEP_NumConnectionData = gs_Connections,
		gs_AddConnections = gs_AddConnections,
		cShow3D = 1,
		gs_ConMat = gs_con_mat,
		MEP_InsShow = 0,
		MEP_cline_show_3D = 0,
		gs_cont_pen = gs_cont_pen,
		ConPosX_1=ConPosX_1, ConPosY_1=ConPosY_1, ConPosZ_1=ConPosZ_1, ConLength_1=ConLength_1, ConEdit_1 = ConEdit_1,
		ConPosX_2=ConPosX_2, ConPosY_2=ConPosY_2, ConPosZ_2=ConPosZ_2, ConLength_2=ConLength_2, ConEdit_2 = ConEdit_2,
		ConShow_3 = 0, ConHotspotShow_3 = 0

	if bWallmountedTap then del 1

	call "MEP_m_ConnectionsACL_4" parameters SetProgram = SetProgram,
		ui_current_con = ui_current_con,
		MEP_NumberConnections = MEP_NumberConnections,
		MEP_NumConnectionData = gs_Connections,
		gs_AddConnections = gs_AddConnections,
		cShow3D = 1,
		gs_ConMat = gs_con_mat,
		MEP_InsShow = 0,
		MEP_cline_show_3D = 0,
		gs_cont_pen = gs_cont_pen,
		ConShow_1 = 0, ConHotspotShow_1 = 0,
		ConShow_2 = 0, ConHotspotShow_2 = 0,
		ConPosX_3=ConPosX_3, ConPosY_3=ConPosY_3, ConPosZ_3=ConPosZ_3, ConLength_3=ConLength_3, ConEdit_3 = 15


return

! -----------------------------------------------------------------------------
! Taps
! -----------------------------------------------------------------------------

"tap":

	if bWallMountedTap then
		if bFlipTap then
			add tapDistCorn, 0, tapHeight
		else
			add 0, tapDistCorn, tapHeight
		endif
		rotz 90 * bFlipTap
	else
		add yWallPos, b / 2, ZZYZX
	endif

	rotz 90
	call "tapType_m" parameters all yWallPos 			= yWallPos,
									bEnableTapEdit		= 1,
									bSinkTap			= 0,
									useOldSimpleTaps	= 0,
									matShowerHead		= gs_tap_mat
	del 1

	if bWallMountedTap then
		del 2
	else
		del 1
	endif

return

! -----------------------------------------------------------------------------
! Texture coordinate system
! -----------------------------------------------------------------------------

"texture coordinate system":

	base
	vert -a/2,   b/2, 0
	vert -a/2+a, b/2, 0
	vert -a/2, b+b/2, 0
	vert -a/2,   b/2, 1
	coor 5, -1, -2, -3, -4
	body -1

return

